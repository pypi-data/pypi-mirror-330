# MindSpore åœºæ™¯çš„ç²¾åº¦æ¯”å¯¹

## ğŸš¨ é‡è¦é€šçŸ¥

**1. ç²¾åº¦æ¯”å¯¹å·²æ”¯æŒè‡ªåŠ¨è¯†åˆ«stack.jsonå¹¶å‘ˆç°NPU_Stack_Infoï¼Œç”¨æˆ·å¯æ— éœ€é…ç½®compare.jsonä¸­çš„"stack_path"å­—æ®µå’Œå‘½ä»¤è¡Œä¸­çš„-så‚æ•°ã€‚å…·ä½“ä½¿ç”¨å‚è§â€œ4.1 æ¯”å¯¹æ–‡ä»¶â€ä¸­çš„å‚æ•°è¯´æ˜ã€‚å‘½ä»¤è¡Œæ–¹å¼ä¸­çš„-sï¼ˆ--stack_modeï¼‰å°†äº2025.9.30åºŸå¼ƒï¼Œå¹¶ä¸”ä¸å†éœ€è¦é…ç½®compare.jsonä¸­çš„"stack_path"å­—æ®µã€‚**


## 1 ç®€ä»‹

msprobeç²¾åº¦æ¯”å¯¹å·¥å…·ä¸»è¦ç”¨äºå¦‚ä¸‹åœºæ™¯ï¼š

- MindSporeæ¡†æ¶å†…æ¯”å¯¹
  - é€šè¿‡å¯¹åŒä¸€ä¸ªç½‘ç»œæ¨¡å‹ï¼Œåœ¨ä¸¤ä¸ªä¸åŒç‰ˆæœ¬çš„MindSporeé™æ€å›¾ç¯å¢ƒä¸‹ï¼Œè¾“å…¥ç›¸åŒçš„è®­ç»ƒæ•°æ®ï¼Œåœ¨åˆ†åˆ«å¾—åˆ°API dumpæ•°æ®åï¼Œå¯¹è¿™ä¸¤ä¸ªAPI dumpæ•°æ®è¿›è¡Œå…¨é‡è‡ªåŠ¨æ¯”å¯¹ï¼Œä»è€Œå¿«é€Ÿå®šä½ä¸åŒç‰ˆæœ¬ä¹‹é—´çš„ç²¾åº¦é—®é¢˜ã€‚
  - é€šè¿‡å¯¹åŒä¸€ä¸ªç½‘ç»œæ¨¡å‹ï¼Œåœ¨ä¸¤ä¸ªä¸åŒç‰ˆæœ¬çš„MindSporeé™æ€å›¾ç¯å¢ƒä¸‹ï¼Œè¾“å…¥ç›¸åŒçš„è®­ç»ƒæ•°æ®ï¼Œåœ¨åˆ†åˆ«å¾—åˆ°kernel dumpæ•°æ®åï¼Œå¯¹è¿™ä¸¤ä¸ªkernel dumpæ•°æ®è¿›è¡Œå…¨é‡è‡ªåŠ¨æ¯”å¯¹ï¼Œä»è€Œå¿«é€Ÿå®šä½ä¸åŒç‰ˆæœ¬ä¹‹é—´çš„ç²¾åº¦é—®é¢˜ã€‚
  - é€šè¿‡å¯¹åŒä¸€ä¸ªç½‘ç»œæ¨¡å‹ï¼Œåœ¨ä¸¤ä¸ªä¸åŒç‰ˆæœ¬çš„MindSporeåŠ¨æ€å›¾ç¯å¢ƒä¸‹ï¼Œè¾“å…¥ç›¸åŒçš„è®­ç»ƒæ•°æ®ï¼Œåœ¨åˆ†åˆ«å¾—åˆ°cell dumpæ•°æ®åï¼Œå¯¹è¿™ä¸¤ä¸ªcellæ¨¡å—è¿›è¡Œå…¨é‡è‡ªåŠ¨æ¯”å¯¹ï¼Œä»è€Œå¿«é€Ÿå®šä½ä¸åŒç‰ˆæœ¬ä¹‹é—´çš„ç²¾åº¦é—®é¢˜ã€‚
- MindSporeä¸PyTorchè·¨æ¡†æ¶æ¯”å¯¹
  - é€šè¿‡å¯¹åŒä¸€ä¸ªç½‘ç»œæ¨¡å‹ï¼Œåœ¨æ•´ç½‘ç¯å¢ƒä¸‹åˆ†åˆ«åœ¨MindSporeåŠ¨æ€å›¾å’ŒPyTorchç¯å¢ƒä¸‹è·å¾—API dumpæ•°æ®ï¼Œä»¥PyTorchæ•°æ®ä½œä¸ºæ ‡æ†ï¼Œè¿›è¡Œè‡ªåŠ¨æ¯”å¯¹ï¼Œä»è€Œå®ç°è·¨æ¡†æ¶çš„ç²¾åº¦å¯¹æ¯”ã€‚
  - é€šè¿‡å¯¹åŒä¸€ä¸ªç½‘ç»œæ¨¡å‹ï¼Œåœ¨æ•´ç½‘ç¯å¢ƒä¸‹åˆ†åˆ«åœ¨MindSporeåŠ¨æ€å›¾å’ŒPyTorchç¯å¢ƒä¸‹è·å¾—cell dumpæ•°æ®ï¼Œç”±ç”¨æˆ·æŒ‡å®šå¯ä»¥æ¯”å¯¹çš„cell listï¼Œä»¥PyTorchæ•°æ®ä½œä¸ºæ ‡æ†ï¼Œè¿›è¡Œè‡ªåŠ¨æ¯”å¯¹ï¼Œä»è€Œå®ç°è·¨æ¡†æ¶çš„ç²¾åº¦å¯¹æ¯”ã€‚
  - é€šè¿‡å¯¹åŒä¸€ä¸ªç½‘ç»œæ¨¡å‹ï¼Œåœ¨æ•´ç½‘ç¯å¢ƒä¸‹åˆ†åˆ«åœ¨MindSporeåŠ¨æ€å›¾å’ŒPyTorchç¯å¢ƒä¸‹è·å¾—APIæˆ–æ¨¡å—dumpæ•°æ®ï¼Œç”±ç”¨æˆ·æŒ‡å®šå¯ä»¥æ¯”å¯¹çš„APIæˆ–æ¨¡å—ï¼Œä»¥PyTorchæ•°æ®ä½œä¸ºæ ‡æ†ï¼Œè¿›è¡Œè‡ªåŠ¨æ¯”å¯¹ï¼Œä»è€Œå®ç°è·¨æ¡†æ¶çš„ç²¾åº¦å¯¹æ¯”ã€‚
  - é€šè¿‡å¯¹åŒä¸€ä¸ªç½‘ç»œæ¨¡å‹ï¼Œåœ¨æ•´ç½‘ç¯å¢ƒä¸‹åˆ†åˆ«åœ¨MindSporeåŠ¨æ€å›¾å’ŒPyTorchç¯å¢ƒä¸‹è·å¾—APIæˆ–æ¨¡å—dumpæ•°æ®ï¼Œç”±ç”¨æˆ·æŒ‡å®šå¯ä»¥æ¯”å¯¹çš„æ¨¡å‹ä»£ç ä¸­çš„Layerå±‚ï¼Œä»¥PyTorchæ•°æ®ä½œä¸ºæ ‡æ†ï¼Œè¿›è¡Œè‡ªåŠ¨æ¯”å¯¹ï¼Œä»è€Œå®ç°è·¨æ¡†æ¶çš„ç²¾åº¦å¯¹æ¯”ã€‚

æ‰§è¡Œç²¾åº¦æ¯”å¯¹æ“ä½œéœ€è¦å®‰è£…msprobeå·¥å…·ã€‚è¯¦è§ã€Š[MindStudioç²¾åº¦è°ƒè¯•å·¥å…·](../README.md)ã€‹çš„â€œå·¥å…·å®‰è£…â€ç« èŠ‚ã€‚

## 2 å‘½ä»¤è¡Œæ¯”å¯¹

ç²¾åº¦æ¯”å¯¹å·¥å…·ç›®å‰ä½¿ç”¨æ–¹å¼ä¸ºå‘½ä»¤è¡Œå½¢å¼ã€‚

### 2.1 æ¯”å¯¹å‘½ä»¤è¯´æ˜

å‘½ä»¤ç¤ºä¾‹å¦‚ä¸‹ï¼š

```shell
msprobe -f mindspore compare -i ./compare.json -o ./output -s
```

**å®Œæ•´å‚æ•°è¯´æ˜**

| å‚æ•°å               | è¯´æ˜                                                         | æ˜¯å¦å¿…é€‰ |
| -------------------- | ------------------------------------------------------------ | -------- |
| -iæˆ–--input_path     | æŒ‡å®šæ¯”å¯¹æ–‡ä»¶ã€‚æ¯”å¯¹æ–‡ä»¶å†…å®¹åŠç¤ºä¾‹è¯·å‚è§[æ¯”å¯¹æ–‡ä»¶](#31-æ¯”å¯¹æ–‡ä»¶)æˆ–[æ¯”å¯¹æ–‡ä»¶ï¼ˆkernelï¼‰](#32-æ¯”å¯¹æ–‡ä»¶kernel)ï¼ˆæ¯”å¯¹æ–‡ä»¶ï¼ˆkernelï¼‰ä»…[ä¸åŒç‰ˆæœ¬ä¸‹çš„å…¨é‡kernelæ¯”å¯¹](#23-ä¸åŒç‰ˆæœ¬ä¸‹çš„å…¨é‡kernelæ¯”å¯¹)åœºæ™¯æ”¯æŒï¼‰ã€‚ | æ˜¯       |
| -oæˆ–--output_path    | é…ç½®æ¯”å¯¹ç»“æœæ–‡ä»¶å­˜ç›˜ç›®å½•ï¼Œé»˜è®¤ä¼šåœ¨å½“å‰ç›®å½•åˆ›å»ºoutputç›®å½•ã€‚æ–‡ä»¶åç§°åŸºäºæ—¶é—´æˆ³è‡ªåŠ¨ç”Ÿæˆï¼Œæ ¼å¼ä¸ºï¼š<br>        `compare_result_{timestamp}.xlsx`<br/>        `compare_result_{rank_id}_{step_id}_{timestamp}.xlsx`ï¼ˆä»…[ä¸åŒç‰ˆæœ¬ä¸‹çš„å…¨é‡kernelæ¯”å¯¹](#23-ä¸åŒç‰ˆæœ¬ä¸‹çš„å…¨é‡kernelæ¯”å¯¹)åœºæ™¯æ”¯æŒï¼‰ã€‚ | å¦       |
| -sæˆ–--stack_mode     | æ¯”å¯¹ç»“æœå±•ç¤ºè°ƒç”¨æ ˆä¿¡æ¯ï¼ˆNPU_Stack_Infoï¼‰çš„å¼€å…³ï¼Œbool ç±»å‹ã€‚å•å¡åœºæ™¯å¼€å¯æ—¶ï¼Œéœ€è¦ä½¿ç”¨[æ¯”å¯¹æ–‡ä»¶](#31-æ¯”å¯¹æ–‡ä»¶)çš„å•å¡åœºæ™¯é…ç½®stack_pathæŒ‡å®šstack.jsonæ–‡ä»¶ï¼Œæ‰èƒ½ç”Ÿæˆè¯¦ç»†è°ƒç”¨æ ˆä¿¡æ¯ï¼Œå¦åˆ™åœ¨æ¯”å¯¹æ—¶ä¼šæŠ¥é”™ï¼›æš‚ä¸æ”¯æŒå¤šå¡åœºæ™¯ã€‚é€šè¿‡ç›´æ¥é…ç½®è¯¥å‚æ•°å¼€å¯ï¼Œé»˜è®¤æœªé…ç½®ï¼Œè¡¨ç¤ºå…³é—­ã€‚ | å¦       |
| -cæˆ–--compare_only   | ä»…æ¯”å¯¹å¼€å…³ï¼Œbool ç±»å‹ã€‚è¯¥å‚æ•°é»˜è®¤æœªé…ç½®ï¼Œä¼šå¯ç”¨è‡ªåŠ¨ç²¾åº¦åˆ†æï¼Œå·¥å…·è‡ªåŠ¨é’ˆå¯¹æ¯”å¯¹ç»“æœè¿›è¡Œåˆ†æï¼Œè¯†åˆ«åˆ°ç¬¬ä¸€ä¸ªç²¾åº¦å¯èƒ½ä¸è¾¾æ ‡èŠ‚ç‚¹ï¼ˆåœ¨æ¯”å¯¹ç»“æœæ–‡ä»¶ä¸­çš„ Accuracy Reached or Not åˆ—æ˜¾ç¤ºä¸º Noï¼‰ï¼Œå¹¶ç»™å‡ºé—®é¢˜å¯èƒ½äº§ç”Ÿçš„åŸå› ï¼ˆæ‰“å±å±•ç¤ºå¹¶ç”Ÿæˆ `advisor_{timestamp}.txt` æ–‡ä»¶ï¼‰ã€‚é€šè¿‡é…ç½®è¯¥å‚æ•°å–æ¶ˆè‡ªåŠ¨ç²¾åº¦åˆ†æï¼Œä»…è¾“å‡ºæ¯”å¯¹ç»“æœè¡¨æ ¼ã€‚ | å¦       |
| -fæˆ–--fuzzy_match    | æ¨¡ç³ŠåŒ¹é…ã€‚å¼€å¯åï¼Œå¯¹äºç½‘ç»œä¸­åŒä¸€å±‚çº§ä¸”å‘½åä»…è°ƒç”¨æ¬¡æ•°ä¸åŒçš„APIï¼Œå¯åŒ¹é…å¹¶è¿›è¡Œæ¯”å¯¹ã€‚é€šè¿‡ç›´æ¥é…ç½®è¯¥å‚æ•°å¼€å¯ï¼Œé»˜è®¤æœªé…ç½®ï¼Œè¡¨ç¤ºå…³é—­ã€‚ | å¦       |
| -amæˆ–--api_mapping   | è·¨æ¡†æ¶æ¯”å¯¹ã€‚é…ç½®è¯¥å‚æ•°æ—¶è¡¨ç¤ºå¼€å¯è·¨æ¡†æ¶APIæ¯”å¯¹åŠŸèƒ½ï¼Œå¯ä»¥æŒ‡å®šè‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶*.yamlï¼Œä¸æŒ‡å®šæ˜ å°„æ–‡ä»¶æ—¶æŒ‰ç…§msprobeå®šä¹‰çš„é»˜è®¤æ˜ å°„å…³ç³»è¿›è¡Œæ¯”å¯¹ã€‚è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶çš„æ ¼å¼è¯·å‚è§[è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶ï¼ˆapi_mappingï¼‰](#33-è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶api_mapping)ã€‚ä»…[è·¨æ¡†æ¶çš„APIæ¯”å¯¹](#25-è·¨æ¡†æ¶çš„apiæ¯”å¯¹)åœºæ™¯éœ€è¦é…ç½®ã€‚ | å¦       |
| -cmæˆ–--cell_mapping  | è·¨æ¡†æ¶æ¯”å¯¹ã€‚é…ç½®è¯¥å‚æ•°æ—¶è¡¨ç¤ºå¼€å¯è·¨æ¡†æ¶cellæ¨¡å—æ¯”å¯¹åŠŸèƒ½ï¼Œå¯ä»¥æŒ‡å®šè‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶*.yamlï¼Œä¸æŒ‡å®šæ˜ å°„æ–‡ä»¶æ—¶æŒ‰ç…§msprobeå®šä¹‰çš„é»˜è®¤æ˜ å°„å…³ç³»è¿›è¡Œæ¯”å¯¹ã€‚è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶çš„æ ¼å¼è¯·å‚è§[è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶ï¼ˆcell_mappingï¼‰](#34-è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶cell_mapping)ã€‚ä»…[è·¨æ¡†æ¶çš„cellæ¨¡å—æ¯”å¯¹](#26-è·¨æ¡†æ¶çš„cellæ¨¡å—æ¯”å¯¹)åœºæ™¯éœ€è¦é…ç½®ã€‚ | å¦       |
| -dmæˆ–--data_mapping  | åŒæ¡†æ¶æˆ–è·¨æ¡†æ¶æ¯”å¯¹ã€‚é€šè¿‡æ˜ å°„æ–‡ä»¶æŒ‡å®šä¸¤ä¸ªå…·ä½“å‚æ•°çš„å¯¹åº”å…³ç³»ï¼Œå¯ä»¥åœ¨L0ã€L1æˆ–mixé‡‡é›†åœºæ™¯ä¸‹ä½¿ç”¨ã€‚é…ç½®è¯¥å‚æ•°çš„åŒæ—¶éœ€è¦æŒ‡å®šè‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶*.yamlã€‚è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶çš„æ ¼å¼è¯·å‚è§[è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶ï¼ˆdata_mappingï¼‰](#35-è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶data_mapping)ã€‚ | å¦       |
| -lmæˆ–--layer_mapping | è·¨æ¡†æ¶æ¯”å¯¹ã€‚é…ç½®è¯¥å‚æ•°æ—¶è¡¨ç¤ºå¼€å¯è·¨æ¡†æ¶Layerå±‚çš„æ¯”å¯¹åŠŸèƒ½ï¼ŒæŒ‡å®šæ¨¡å‹ä»£ç ä¸­çš„Layerå±‚åï¼Œå¯ä»¥è¯†åˆ«å¯¹åº”dumpæ•°æ®ä¸­çš„æ¨¡å—æˆ–APIã€‚éœ€è¦æŒ‡å®šè‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶*.yamlã€‚è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶çš„æ ¼å¼è¯·å‚è§[è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶ï¼ˆLayer_mappingï¼‰](#36-è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶layer_mapping)ã€‚ä»…[è·¨æ¡†æ¶çš„Layerå±‚æ¯”å¯¹](#27-è·¨æ¡†æ¶çš„layerå±‚æ¯”å¯¹)åœºæ™¯éœ€è¦é…ç½®ã€‚ | å¦       |

åŠ¨æ€å›¾æ¨¡å¼æ²¡æœ‰å¡«å†™ä»»ä½•mappingæ—¶ï¼ŒæŒ‰ç…§åŒæ¡†æ¶æ¯”å¯¹çš„æ–¹å¼è¿›è¡Œæ¯”å¯¹ï¼Œæ¯”å¯¹æ•°æ®å’Œæ ‡æ†æ•°æ®çš„Cellæˆ–Apiåç§°éœ€è¦å®Œå…¨ç›¸åŒæ‰èƒ½åŒ¹é…å¾—ä¸Šã€‚

### 2.2 ä¸åŒç‰ˆæœ¬ä¸‹çš„å…¨é‡APIæ¯”å¯¹

1. å‚è§ã€Š[MindSpore åœºæ™¯çš„ç²¾åº¦æ•°æ®é‡‡é›†](./06.data_dump_MindSpore.md)ã€‹å®Œæˆä¸åŒç¯å¢ƒä¸‹MindSporeé™æ€å›¾ç²¾åº¦æ•°æ®çš„é‡‡é›†ï¼Œå¾—åˆ°ä¸åŒæ¡†æ¶ç‰ˆæœ¬çš„API dumpæ•°æ®ã€‚

2. åˆ›å»ºæ¯”å¯¹æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹åŠç¤ºä¾‹è¯·å‚è§[æ¯”å¯¹æ–‡ä»¶](#31-æ¯”å¯¹æ–‡ä»¶)ã€‚

3. æ‰§è¡Œå¦‚ä¸‹ç¤ºä¾‹å‘½ä»¤è¿›è¡Œæ¯”å¯¹ï¼š

   ```shell
   msprobe -f mindspore compare -i ./compare.json -o ./output -s
   ```

4. æŸ¥çœ‹æ¯”å¯¹ç»“æœï¼Œè¯·è¯¦è§PyTorchç›®å½•ä¸‹çš„ã€Š[PyTorch åœºæ™¯çš„ç²¾åº¦æ¯”å¯¹-ç²¾åº¦æ¯”å¯¹ç»“æœåˆ†æ](./10.accuracy_compare_PyTorch.md#3-ç²¾åº¦æ¯”å¯¹ç»“æœåˆ†æ)ã€‹ç« èŠ‚ã€‚

### 2.3 ä¸åŒç‰ˆæœ¬ä¸‹çš„å…¨é‡kernelæ¯”å¯¹

1. å‚è§ã€Š[MindSpore åœºæ™¯çš„ç²¾åº¦æ•°æ®é‡‡é›†](./06.data_dump_MindSpore.md)ã€‹å®Œæˆä¸åŒç¯å¢ƒä¸‹MindSporeé™æ€å›¾ç²¾åº¦æ•°æ®çš„é‡‡é›†ï¼Œå¾—åˆ°ä¸åŒæ¡†æ¶ç‰ˆæœ¬çš„kernel dumpæ•°æ®ã€‚

2. åˆ›å»ºæ¯”å¯¹æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹åŠç¤ºä¾‹è¯·å‚è§[æ¯”å¯¹æ–‡ä»¶ï¼ˆkernelï¼‰](#32-æ¯”å¯¹æ–‡ä»¶kernel)ã€‚

3. æ‰§è¡Œå¦‚ä¸‹ç¤ºä¾‹å‘½ä»¤è¿›è¡Œæ¯”å¯¹ï¼š

   ```shell
   msprobe -f mindspore compare -i ./compare.json -o ./output
   ```

   è¯¥åœºæ™¯ä»…æ”¯æŒcompareçš„-iå’Œ-oå‚æ•°ã€‚

4. æŸ¥çœ‹æ¯”å¯¹ç»“æœï¼Œè¯·è¯¦è§PyTorchç›®å½•ä¸‹çš„ã€Š[PyTorch åœºæ™¯çš„ç²¾åº¦æ¯”å¯¹-ç²¾åº¦æ¯”å¯¹ç»“æœåˆ†æ](./10.accuracy_compare_PyTorch.md#3-ç²¾åº¦æ¯”å¯¹ç»“æœåˆ†æ)ã€‹ç« èŠ‚ã€‚

### 2.4 ä¸åŒç‰ˆæœ¬ä¸‹çš„cellæ¨¡å—æ¯”å¯¹

1. é…ç½®[config.json](../config.json)æ–‡ä»¶levelé…ç½®ä¸ºL0ã€taské…ç½®ä¸ºtensoræˆ–statisticså¹¶æŒ‡å®šéœ€è¦dumpçš„cellæ¨¡å—åã€‚

2. å‚è§ã€Š[MindSpore åœºæ™¯çš„ç²¾åº¦æ•°æ®é‡‡é›†](./06.data_dump_MindSpore.md)ã€‹å®Œæˆä¸åŒç¯å¢ƒä¸‹MindSporeåŠ¨æ€å›¾ç²¾åº¦æ•°æ®çš„é‡‡é›†ï¼Œå¾—åˆ°ä¸åŒæ¡†æ¶ç‰ˆæœ¬çš„cellæ¨¡å—dumpæ•°æ®ã€‚

3. åˆ›å»ºæ¯”å¯¹æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹åŠç¤ºä¾‹è¯·å‚è§[æ¯”å¯¹æ–‡ä»¶](#31-æ¯”å¯¹æ–‡ä»¶)ã€‚

4. æ‰§è¡Œå¦‚ä¸‹ç¤ºä¾‹å‘½ä»¤è¿›è¡Œæ¯”å¯¹ï¼š

   ```shell
   msprobe -f mindspore compare -i ./compare.json -o ./output -s
   ```

5. æŸ¥çœ‹æ¯”å¯¹ç»“æœï¼Œè¯·è¯¦è§PyTorchç›®å½•ä¸‹çš„ã€Š[PyTorch åœºæ™¯çš„ç²¾åº¦æ¯”å¯¹-ç²¾åº¦æ¯”å¯¹ç»“æœåˆ†æ](./10.accuracy_compare_PyTorch.md#3-ç²¾åº¦æ¯”å¯¹ç»“æœåˆ†æ)ã€‹ç« èŠ‚ã€‚

### 2.5 è·¨æ¡†æ¶çš„APIæ¯”å¯¹

1. é…ç½®[config.json](../config.json)æ–‡ä»¶levelé…ç½®ä¸ºL1ã€taské…ç½®ä¸ºtensoræˆ–statisticsã€‚

2. å‚è§ã€Š[MindSpore åœºæ™¯çš„ç²¾åº¦æ•°æ®é‡‡é›†](./06.data_dump_MindSpore.md)ã€‹å’Œã€Š[PyTorch åœºæ™¯çš„ç²¾åº¦æ•°æ®é‡‡é›†](./05.data_dump_PyTorch.md)ã€‹å®Œæˆä¸åŒç¯å¢ƒä¸‹APIç²¾åº¦æ•°æ®çš„é‡‡é›†ï¼Œå¾—åˆ°ä¸¤ä¸ªæ¡†æ¶çš„API dumpæ•°æ®ã€‚

3. åˆ›å»ºæ¯”å¯¹æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹åŠç¤ºä¾‹è¯·å‚è§[æ¯”å¯¹æ–‡ä»¶](#31-æ¯”å¯¹æ–‡ä»¶)ã€‚

4. æ‰§è¡Œå¦‚ä¸‹ç¤ºä¾‹å‘½ä»¤è¿›è¡Œæ¯”å¯¹ï¼š

   ```shell
   msprobe -f mindspore compare -i ./compare.json -o ./output -s -am
   ```

   æˆ–

   ```shell
   msprobe -f mindspore compare -i ./compare.json -o ./output -s -am api_mapping.yaml
   ```

   api_mapping.yamlæ–‡ä»¶é…ç½®è¯·å‚è§[è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶ï¼ˆapi_mappingï¼‰](#33-è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶api_mapping)ã€‚
   ä¸ä¼ å…¥api_mapping.yamlçš„æƒ…å†µä¸‹å°†æŒ‰ç…§å†…ç½®çš„apiæ˜ å°„è¿›è¡ŒåŒ¹é…ï¼›ä¼ å…¥api_mapping.yamlçš„æƒ…å†µä¸‹ä¼˜å…ˆæŒ‰ç…§api_mapping.yamlçš„å†…å®¹è¿›è¡ŒåŒ¹é…ï¼Œapi_mapping.yamlä¸­æ²¡æœ‰æ¶‰åŠçš„æŒ‰ç…§å†…ç½®çš„apiæ˜ å°„è¿›è¡ŒåŒ¹é…ã€‚

   æ­¤å¤–ï¼Œä¹Ÿå¯ä»¥é€šè¿‡data_mapping.yamlæ–‡ä»¶å®ç°å…·ä½“å‚æ•°çš„åŒ¹é…ï¼Œä¾‹ï¼š
   ```shell
   msprobe -f mindspore compare -i ./compare.json -o ./output -s -dm data_mapping.yaml
   ```
   data_mapping.yamlçš„å†™æ³•è¯·å‚è§[è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶ï¼ˆdata_mappingï¼‰](#35-è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶data_mapping)ã€‚

5. æŸ¥çœ‹æ¯”å¯¹ç»“æœï¼Œè¯·è¯¦è§PyTorchç›®å½•ä¸‹çš„ã€Š[PyTorch åœºæ™¯çš„ç²¾åº¦æ¯”å¯¹-ç²¾åº¦æ¯”å¯¹ç»“æœåˆ†æ](./10.accuracy_compare_PyTorch.md#3-ç²¾åº¦æ¯”å¯¹ç»“æœåˆ†æ)ã€‹ç« èŠ‚ã€‚

### 2.6 è·¨æ¡†æ¶çš„cellæ¨¡å—æ¯”å¯¹

1. é…ç½®[config.json](../config.json)æ–‡ä»¶levelé…ç½®ä¸ºL0ã€taské…ç½®ä¸ºtensoræˆ–statisticså¹¶æŒ‡å®šéœ€è¦dumpçš„cellæ¨¡å—åã€‚

2. å‚è§ã€Š[MindSpore åœºæ™¯çš„ç²¾åº¦æ•°æ®é‡‡é›†](./06.data_dump_MindSpore.md)ã€‹å’Œã€Š[PyTorch åœºæ™¯çš„ç²¾åº¦æ•°æ®é‡‡é›†](./05.data_dump_PyTorch.md)ã€‹å®Œæˆä¸åŒç¯å¢ƒä¸‹cellæ¨¡å—ç²¾åº¦æ•°æ®çš„é‡‡é›†ï¼Œå¾—åˆ°ä¸¤ä¸ªæ¡†æ¶çš„cellæ¨¡å—dumpæ•°æ®ã€‚

3. åˆ›å»ºæ¯”å¯¹æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹åŠç¤ºä¾‹è¯·å‚è§[æ¯”å¯¹æ–‡ä»¶](#31-æ¯”å¯¹æ–‡ä»¶)ã€‚

4. æ‰§è¡Œå¦‚ä¸‹ç¤ºä¾‹å‘½ä»¤è¿›è¡Œæ¯”å¯¹ï¼š

   ```shell
   msprobe -f mindspore compare -i ./compare.json -o ./output -s -cm
   ```

   æˆ–

   ```shell
   msprobe -f mindspore compare -i ./compare.json -o ./output -s -cm cell_mapping.yaml
   ```

   cell_mapping.yamlæ–‡ä»¶é…ç½®è¯·å‚è§[è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶ï¼ˆcell_mappingï¼‰](#34-è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶cell_mapping)ã€‚
   ä¸ä¼ å…¥cell_mapping.yamlçš„æƒ…å†µä¸‹ä»…å°†Cellæ”¹æˆModuleåè¿›è¡ŒåŒ¹é…ï¼›ä¼ å…¥cell_mapping.yamlçš„æƒ…å†µä¸‹å°†æŒ‰ç…§cell_mapping.yamlçš„å†…å®¹è¿›è¡ŒåŒ¹é…ã€‚

   æ­¤å¤–ï¼Œä¹Ÿå¯ä»¥é€šè¿‡data_mapping.yamlæ–‡ä»¶å®ç°å…·ä½“å‚æ•°çš„åŒ¹é…ï¼Œä¾‹ï¼š
   ```shell
   msprobe -f mindspore compare -i ./compare.json -o ./output -s -dm data_mapping.yaml
   ```
   data_mapping.yamlçš„å†™æ³•è¯·å‚è§[è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶ï¼ˆdata_mappingï¼‰](#35-è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶data_mapping)ã€‚

5. æŸ¥çœ‹æ¯”å¯¹ç»“æœï¼Œè¯·è¯¦è§PyTorchç›®å½•ä¸‹çš„ã€Š[PyTorch åœºæ™¯çš„ç²¾åº¦æ¯”å¯¹-ç²¾åº¦æ¯”å¯¹ç»“æœåˆ†æ](./10.accuracy_compare_PyTorch.md#3-ç²¾åº¦æ¯”å¯¹ç»“æœåˆ†æ)ã€‹ç« èŠ‚ã€‚

### 2.7 è·¨æ¡†æ¶çš„Layerå±‚æ¯”å¯¹

layer_mappingå¯ä»¥ä»Layerå±‚è¯†åˆ«æ•´ç½‘çš„APIå’ŒCellï¼Œç®€åŒ–é…ç½®ã€‚

1. é…ç½®[config.json](../config.json)æ–‡ä»¶levelé…ç½®ä¸ºL0æˆ–mixã€taské…ç½®ä¸ºtensoræˆ–statisticså¹¶æŒ‡å®šéœ€è¦dumpçš„APIæˆ–æ¨¡å—åã€‚

2. å‚è§ã€Š[MindSpore åœºæ™¯çš„ç²¾åº¦æ•°æ®é‡‡é›†](./06.data_dump_MindSpore.md)ã€‹å’Œã€Š[PyTorch åœºæ™¯çš„ç²¾åº¦æ•°æ®é‡‡é›†](./05.data_dump_PyTorch.md)ã€‹å®Œæˆä¸åŒç¯å¢ƒä¸‹APIæˆ–æ¨¡å—ç²¾åº¦æ•°æ®çš„é‡‡é›†ï¼Œå¾—åˆ°ä¸¤ä¸ªæ¡†æ¶çš„APIæˆ–æ¨¡å—dumpæ•°æ®ã€‚

3. åˆ›å»ºæ¯”å¯¹æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹åŠç¤ºä¾‹è¯·å‚è§[æ¯”å¯¹æ–‡ä»¶](#31-æ¯”å¯¹æ–‡ä»¶)ã€‚

4. æ‰§è¡Œå¦‚ä¸‹ç¤ºä¾‹å‘½ä»¤è¿›è¡Œæ¯”å¯¹ï¼š

   ```shell
   msprobe -f mindspore compare -i ./compare.json -o ./output -s -lm layer_mapping.yaml
   ```

   layer_mapping.yamlæ–‡ä»¶é…ç½®è¯·å‚è§[è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶ï¼ˆlayer_mappingï¼‰](#36-è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶layer_mapping)ã€‚

   æ­¤å¤–ï¼Œä¹Ÿå¯ä»¥é€šè¿‡data_mapping.yamlæ–‡ä»¶å®ç°å…·ä½“å‚æ•°çš„åŒ¹é…ï¼Œä¾‹ï¼š
   ```shell
   msprobe -f mindspore compare -i ./compare.json -o ./output -s -dm data_mapping.yaml
   ```
   data_mapping.yamlçš„å†™æ³•è¯·å‚è§[è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶ï¼ˆdata_mappingï¼‰](#35-è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶data_mapping)ã€‚

5. æŸ¥çœ‹æ¯”å¯¹ç»“æœï¼Œè¯·è¯¦è§PyTorchç›®å½•ä¸‹çš„ã€Š[PyTorch åœºæ™¯çš„ç²¾åº¦æ¯”å¯¹-ç²¾åº¦æ¯”å¯¹ç»“æœåˆ†æ](./10.accuracy_compare_PyTorch.md#3-ç²¾åº¦æ¯”å¯¹ç»“æœåˆ†æ)ã€‹ç« èŠ‚ã€‚

## 3 å¤šå¡æ¯”å¯¹ç»“æœæå–æ±‡æ€»é€šä¿¡ç®—å­æ•°æ®

æœ¬åŠŸèƒ½æ˜¯å°†å¤šå¡æ¯”å¯¹åœºæ™¯çš„æ¯”å¯¹ç»“æœï¼Œè¿›è¡Œé€šä¿¡ç®—å­æ•°æ®æå–å’Œæ±‡æ€»ï¼Œè¾“å‡ºæ•´ç†å¥½çš„é€šä¿¡ç®—å­å¤šå¡æ¯”å¯¹ç²¾åº¦è¡¨ã€‚

**çº¦æŸ**

- ä¸æ”¯æŒMD5æ¯”å¯¹ç»“æœã€‚
- ä¸æ”¯æŒMindSporeé™æ€å›¾æ¯”å¯¹ç»“æœã€‚

**å‘½ä»¤ç¤ºä¾‹**

```bash
msprobe -f mindspore merge_result -i ./input_dir -o ./output_dir -config ./config.yaml
```

**å®Œæ•´å‚æ•°è¯´æ˜**

| å‚æ•°å                 | è¯´æ˜                                                         | æ˜¯å¦å¿…é€‰ |
| ---------------------- | ------------------------------------------------------------ | -------- |
| -i æˆ– --input_dir      | å¤šå¡æ¯”å¯¹ç»“æœå­˜ç›˜ç›®å½•ï¼Œå³ä½¿ç”¨compareæ¯”å¯¹çš„ç»“æœè¾“å‡ºç›®å½•ï¼Œstrç±»å‹ã€‚æ‰€æœ‰æ¯”å¯¹ç»“æœåº”å…¨éƒ¨ä¸ºçœŸå®æ•°æ®æ¯”å¯¹ç»“æœæˆ–ç»Ÿè®¡æ•°æ®æ¯”å¯¹ç»“æœï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´æ±‡æ€»æ•°æ®ä¸å®Œæ•´ã€‚ | æ˜¯       |
| -o æˆ– --output_dir     | æ•°æ®æå–æ±‡æ€»ç»“æœå­˜ç›˜ç›®å½•ï¼Œstrç±»å‹ã€‚æ–‡ä»¶åç§°åŸºäºæ—¶é—´æˆ³è‡ªåŠ¨ç”Ÿæˆï¼Œæ ¼å¼ä¸ºï¼š`multi_ranks_compare_merge_{timestamp}.xlsx`ã€‚ | æ˜¯       |
| -configæˆ–--config-path | æŒ‡å®šéœ€è¦æ±‡æ€»æ•°æ®çš„APIå’Œæ¯”å¯¹æŒ‡æ ‡çš„yamlæ–‡ä»¶è·¯å¾„ï¼Œstrç±»å‹ã€‚<br>yamlæ–‡ä»¶è¯¦ç»†ä»‹ç»è§ä¸‹æ–‡â€œ**yamlæ–‡ä»¶è¯´æ˜**â€ã€‚ | æ˜¯       |

**yamlæ–‡ä»¶è¯´æ˜**

ä»¥config.yamlæ–‡ä»¶åä¸ºä¾‹ï¼Œé…ç½®ç¤ºä¾‹å¦‚ä¸‹ï¼š

```
api:
- Distributed.all_reduce
- Distributed.all_gather_into_tensor
compare_index:
- Max diff
- L2norm diff
- MeanRelativeErr
```

| å‚æ•°å        | è¯´æ˜                                                         |
| ------------- | ------------------------------------------------------------ |
| api           | è¡¨ç¤ºéœ€è¦æ±‡æ€»çš„APIæˆ–moduleåç§°ã€‚å¦‚æœæ²¡æœ‰é…ç½®ï¼Œå·¥å…·ä¼šæç¤ºæŠ¥é”™ã€‚<br/>apiåç§°é…ç½®æ ¼å¼ä¸ºï¼š`{api_type}.{api_name}.{APIè°ƒç”¨æ¬¡æ•°}.{å‰å‘åå‘}`<br/>é¡»æŒ‰é¡ºåºé…ç½®ä»¥ä¸Šå››ä¸ªå­—æ®µï¼Œå¯æŒ‰å¦‚ä¸‹ç»„åˆé…ç½®ï¼š<br/>        {api_type}<br/>        {api_type}.{api_name}<br/>        {api_type}.{api_name}.{APIè°ƒç”¨æ¬¡æ•°}<br/>        {api_type}.{api_name}.{APIè°ƒç”¨æ¬¡æ•°}.{å‰å‘åå‘}<br/>è¿™é‡Œçš„apiæŒ‡ä»£APIæˆ–moduleã€‚ |
| compare_index | è¡¨ç¤ºéœ€è¦æ±‡æ€»çš„æ¯”å¯¹æŒ‡æ ‡ã€‚compare_indexéœ€ä¸ºdump_modeå¯¹åº”æ¯”å¯¹æŒ‡æ ‡çš„å­é›†ã€‚å¦‚æœæ²¡æœ‰é…ç½®ï¼Œå·¥å…·å°†æ ¹æ®æ¯”å¯¹ç»“æœè‡ªåŠ¨æå–dump_modeå¯¹åº”çš„å…¨éƒ¨æ¯”å¯¹æŒ‡æ ‡è¿›è¡Œæ±‡æ€»ã€‚<br>ç»Ÿè®¡æ•°æ®æ¨¡å¼æ¯”å¯¹æŒ‡æ ‡ï¼šMax diffã€Min diffã€Mean diffã€Norm diffã€MaxRelativeErrã€MinRelativeErrã€MeanRelativeErrã€NormRelativeErr<br>çœŸå®æ•°æ®æ¨¡å¼æ¯”å¯¹æŒ‡æ ‡ï¼šCosineã€MaxAbsErrã€MaxRelativeErrã€One Thousandth Err Ratioã€Five Thousandths Err Ratio |

**æ±‡æ€»ç»“æœä»¶è¯´æ˜**

å¤šå¡æ•°æ®æ±‡æ€»ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

![merge_result](img/merge_result.png)

1. NPU Nameåˆ—è¡¨ç¤ºAPIæˆ–moduleåç§°ã€‚
2. rank*åˆ—ä¸ºå¤šå¡æ•°æ®ã€‚
3. ä¸åŒæ¯”å¯¹æŒ‡æ ‡çš„æ•°æ®é€šè¿‡ä¸åŒsheeté¡µå‘ˆç°ã€‚
4. å¦‚æœä¸€ä¸ªAPIæˆ–moduleåœ¨æŸå¼ å¡ä¸Šæ‰¾ä¸åˆ°æ•°æ®ï¼Œæ±‡æ€»ç»“æœä¸­å°†ç©ºç™½å‘ˆç°ã€‚

## 4 é™„å½•

### 4.1 æ¯”å¯¹æ–‡ä»¶

ä»¥åœ¨å½“å‰ç›®å½•åˆ›å»º./compare.jsonä¸ºä¾‹ï¼Œå•å¡åœºæ™¯ç¤ºä¾‹å¦‚ä¸‹ï¼š


  ```json
{
"npu_path": "./npu_dump/dump.json",
"bench_path": "./bench_dump/dump.json",
"stack_path": "./npu_dump/stack.json",
"is_print_compare_log": true
}
  ```

å¤šå¡åœºæ™¯ç¤ºä¾‹å¦‚ä¸‹ï¼š
```json
{
"npu_path": "./npu_dump/step0", # éœ€å¡«å†™åˆ°stepå±‚çº§ï¼ˆrankçš„ä¸Šä¸€å±‚çº§ï¼‰
"bench_path": "./bench_dump/step0", # éœ€å¡«å†™åˆ°stepå±‚çº§ï¼ˆrankçš„ä¸Šä¸€å±‚çº§ï¼‰
"is_print_compare_log": true
}
```

**å‚æ•°è¯´æ˜**

| å‚æ•°å               | è¯´æ˜                                                         | æ˜¯å¦å¿…é€‰ |
| -------------------- | ------------------------------------------------------------ |------|
| npu_path             | é…ç½®NPUç¯å¢ƒä¸‹çš„dump.jsonæ–‡ä»¶ï¼ˆå•å¡åœºæ™¯ï¼‰ã€‚è·¨æ¡†æ¶åœºæ™¯æŒ‡å®šä¸ºMindSporeçš„jsonæ–‡ä»¶ã€‚æ•°æ®ç±»å‹ï¼šstrã€‚ | æ˜¯    |
| bench_path           | é…ç½®CPUã€GPUæˆ–NPUç¯å¢ƒä¸‹çš„dump.jsonæ–‡ä»¶ï¼ˆå•å¡åœºæ™¯ï¼‰ã€‚ è·¨æ¡†æ¶åœºæ™¯æŒ‡å®šä¸ºPyTorchçš„jsonæ–‡ä»¶ã€‚æ•°æ®ç±»å‹ï¼šstrã€‚ | æ˜¯    |
| stack_path           | é…ç½®NPU dumpç›®å½•ä¸‹çš„stack.jsonæ–‡ä»¶ã€‚æ•°æ®ç±»å‹ï¼šstrã€‚ å¦‚æœæ²¡æœ‰é…ç½®stack_pathï¼Œå‘½ä»¤è¡Œ-så‚æ•°ä¸ç”Ÿæ•ˆï¼Œç¨‹åºè‡ªåŠ¨è¯†åˆ«æ˜¯å¦å­˜åœ¨stack.jsonæ–‡ä»¶ï¼Œå¦‚å­˜åœ¨ï¼Œåˆ™æ¯”å¯¹ç»“æœä¸­å‘ˆç°NPU_Stack_Infoï¼Œå¦‚ä¸å­˜åœ¨ï¼Œåˆ™ä¸å‘ˆç°ã€‚å¦‚æœé…ç½®äº†stack_pathï¼Œæ¯”å¯¹ç»“æœä¸­æ˜¯å¦å‘ˆç°NPU_Stack_Infoåˆ™é€šè¿‡å‘½ä»¤è¡Œå‚æ•°-sæ¥æ§åˆ¶ã€‚         | å¦    |
| is_print_compare_log | é…ç½®æ˜¯å¦å¼€å¯å•ä¸ªç®—å­çš„æ—¥å¿—æ‰“å±ã€‚å¯å–å€¼trueæˆ–falseï¼Œé»˜è®¤ä¸ºtrueã€‚å…³é—­ååˆ™åªè¾“å‡ºå¸¸è§„æ—¥å¿—ã€‚æ•°æ®ç±»å‹ï¼šbool | å¦    |

### 4.2 æ¯”å¯¹æ–‡ä»¶ï¼ˆkernelï¼‰

ä»…[ä¸åŒç‰ˆæœ¬ä¸‹çš„å…¨é‡kernelæ¯”å¯¹](#23-ä¸åŒç‰ˆæœ¬ä¸‹çš„å…¨é‡kernelæ¯”å¯¹)åœºæ™¯æ”¯æŒã€‚

ä»¥åœ¨å½“å‰ç›®å½•åˆ›å»º./compare.jsonä¸ºä¾‹ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

- å•å¡åœºæ™¯ï¼š

  ```json
  {
  "npu_path": "./npu_dump",
  "bench_path": "./bench_dump",
  "rank_id": [1],
  "step_id": []
  }
  ```

- å¤šå¡åœºæ™¯ï¼š

  ```json
  {
  "npu_path": "./npu_dump",
  "bench_path": "./bench_dump",
  "rank_id": [],
  "step_id": []
  }
  ```


**å‚æ•°è¯´æ˜**

| å‚æ•°å     | è¯´æ˜                                                         | æ˜¯å¦å¿…é€‰ |
| ---------- | ------------------------------------------------------------ | -------- |
| npu_path   | é…ç½®NPUç¯å¢ƒä¸‹çš„çœŸå®æ•°æ®ç›®å½•ã€‚æ•°æ®ç±»å‹ï¼šstrã€‚                 | æ˜¯       |
| bench_path | é…ç½®NPUç¯å¢ƒä¸‹çš„çœŸå®æ•°æ®ç›®å½•ã€‚æ•°æ®ç±»å‹ï¼šstrã€‚                 | æ˜¯       |
| rank_id    | é…ç½®æ¯”å¯¹çš„Rank IDã€‚npu_pathå’Œbench_pathç›®å½•ä¸‹çš„dumpæ–‡ä»¶éœ€è¦å­˜åœ¨å¯¹åº”Rankçš„æ•°æ®ã€‚é»˜è®¤ä¸ºç©ºï¼Œè¡¨ç¤ºæ¯”å¯¹æ‰€æœ‰Rankã€‚å¯é…ç½®ä¸€ä¸ªæˆ–å¤šä¸ªRankï¼Œå¤šä¸ªRank IDç”¨é€—å·éš”å¼€ï¼Œä¾‹å¦‚ï¼š"rank_id": [1,2,3]ã€‚æ•°æ®ç±»å‹ï¼šlist[int]ã€‚ | å¦       |
| step_id    | é…ç½®æ¯”å¯¹çš„Step IDã€‚npu_pathå’Œbench_pathç›®å½•ä¸‹çš„dumpæ–‡ä»¶éœ€è¦å­˜åœ¨å¯¹åº”Stepçš„æ•°æ®ã€‚é»˜è®¤ä¸ºç©ºï¼Œè¡¨ç¤ºæ¯”å¯¹æ‰€æœ‰Stepã€‚å¯é…ç½®ä¸€ä¸ªæˆ–å¤šä¸ªStepï¼Œå¤šä¸ªStep IDç”¨é€—å·éš”å¼€ï¼Œä¾‹å¦‚ï¼š"step_id": [1,2,3]ã€‚æ•°æ®ç±»å‹ï¼šlist[int]ã€‚ | å¦       |

### 4.3 è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶ï¼ˆapi_mappingï¼‰

æ–‡ä»¶åæ ¼å¼ï¼š\*.yamlï¼Œ*ä¸ºæ–‡ä»¶åï¼Œå¯è‡ªå®šä¹‰ã€‚

æ–‡ä»¶å†…å®¹æ ¼å¼ï¼š

```yaml
ms_api: {ms_api_name}
pt_api: {pt_api_name}
ms_args:
- {index1}
- {index2}
...
- {indexN}
pt_args:
- {index1}
- {index2}
...
- {indexN}
ms_outputs:
- {index1}
- {index2}
...
- {indexN}
pt_outputs:
- {index1}
- {index2}
...
- {indexN}
```

- ms_api/pt_apiï¼šåˆ†åˆ«ä¸ºMindSporeå’ŒPyTorchæ¡†æ¶çš„APIåç§°ï¼Œé…ç½®æ ¼å¼ä¸º{api_type}.{api_name}ã€‚APIåç§°è¯·åˆ†åˆ«ä»ã€Š[MindSpore åœºæ™¯çš„ç²¾åº¦æ•°æ®é‡‡é›†](./06.data_dump_MindSpore.md)ã€‹å’Œã€Š[PyTorch åœºæ™¯çš„ç²¾åº¦æ•°æ®é‡‡é›†](./05.data_dump_PyTorch.md)ã€‹ä¸­çš„dump.jsonæ–‡ä»¶è·å–ã€‚
- ms_args/pt_argsï¼šåˆ†åˆ«ä¸ºms_api/pt_apiå¯¹åº”çš„MindSporeå’ŒPyTorchæ¡†æ¶APIçš„å…¥å‚çš„åºå·ã€‚
- ms_outputs/pt_outputsï¼šåˆ†åˆ«ä¸ºms_api/pt_apiå¯¹åº”çš„MindSporeå’ŒPyTorchæ¡†æ¶APIçš„è¾“å‡ºçš„åºå·ã€‚

**è¯´æ˜**ï¼š

- MindSporeå’ŒPyTorchæ¡†æ¶çš„APIæ˜ å°„å…³ç³»å¯ä»¥ä»ã€Š[PyTorchä¸MindSpore APIæ˜ å°„è¡¨](https://www.mindspore.cn/docs/zh-CN/r2.3.0rc2/note/api_mapping/pytorch_api_mapping.html)ã€‹è·å–ï¼Œå…¶ä¸­PyTorchä¸MindSpore APIåç§°å‰ç¼€çš„æ˜ å°„å…³ç³»å¦‚ä¸‹ï¼š

  | PyTorch             | PyTorchåœ¨dumpæ–‡ä»¶ä¸­çš„åç§° | MindSpore        | MindSporeåœ¨dumpæ–‡ä»¶ä¸­çš„åç§° |
  | ------------------- | ------------------------- | ---------------- | --------------------------- |
  | torch.nn.functional | Functional                | mindspore.ops    | Functional                  |
  | torch.Tensor        | Tensor                    | mindspore.Tensor | Tensor                      |
  | torch               | Torch                     | mindspore.ops    | Functional                  |

  å®é™…é…ç½®è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶ï¼ˆAPIï¼‰æ—¶éœ€è¦ä½¿ç”¨dumpæ–‡ä»¶ä¸­çš„åç§°ã€‚

- è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶ï¼ˆAPIï¼‰éœ€è¦æ»¡è¶³ms_args/pt_argsåˆ—è¡¨ä¸­çš„å…ƒç´ ä¸ªæ•°ä¸€è‡´ï¼Œms_outputs/pt_outputsç›¸åŒã€‚

- é¡»ç¡®ä¿åˆ—è¡¨è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶ï¼ˆAPIï¼‰é…ç½®å…ƒç´ çš„åˆæ³•æ€§ï¼Œæ¯”å¦‚ms_args/pt_argsçš„APIç”¨åˆ°çš„å‚æ•°åªæœ‰3ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆç”¨æˆ·å®é™…æŒ‡å®šçš„å‚æ•°åºå·åªèƒ½åŒ…å«0ã€1ã€2ï¼›å¦å¤–å‚æ•°åºå·åˆ—è¡¨ä¸­çš„å€¼ä¸èƒ½é‡å¤ã€‚

æ–‡ä»¶å†…å®¹ç¤ºä¾‹ï¼š

```yaml
ms_api: Functional.abs
pt_api: Torch.abs
ms_args:
- 0
- 1
pt_args:
- 0
- 1
ms_outputs:
- 0
- 1
pt_outputs:
- 0
- 1
# ms_args/pt_argså’Œms_outputs/pt_outputså‚æ•°çš„é…ç½®éœ€è¦æ ¹æ®ms_api/pt_apiçš„APIå…¥å‚å’Œè¾“å‡ºçš„é¡ºåºï¼Œä¾‹å¦‚Functional.abs APIçš„å…¥å‚ä¸ºï¼ˆa b cï¼‰ï¼Œé‚£å¯¹åº”çš„ms_argsä¸º0 1 2ï¼Œå¯æ ¹æ®å®é™…éœ€è¦é€‰æ‹©ï¼Œè€ŒTorch.absçš„å…¥å‚å¦‚æœæ˜¯ï¼ˆa b cï¼‰ï¼Œé‚£ä¹ˆms_argså’Œpt_argsé…ç½®ä¸€è‡´å³å¯ï¼Œä½†å¦‚æœTorch.absçš„å…¥å‚å¦‚æœæ˜¯ï¼ˆa cï¼‰æˆ–å…¶ä»–ä¸Functional.absä¸å®Œå…¨æ˜ å°„çš„å€¼ï¼Œé‚£ä¹ˆms_argså’Œpt_argsé…ç½®çš„åºå·éœ€è¦ä¸å…¥å‚å¯¹åº”ï¼ŒTorch.absï¼ˆa cï¼‰çš„åºå·ä¸º0 1ï¼ŒFunctional.absï¼ˆa b cï¼‰ä¸º0 1 2ï¼Œåªæœ‰aå’Œcå‚æ•°å¯ä»¥æ˜ å°„ï¼Œé‚£ä¹ˆms_argsé…ç½®ä¸º0 2ï¼Œpt_argsé…ç½®ä¸º0 1ã€‚ms_outputs/pt_outputsåŒç†ã€‚
```

### 4.4 è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶ï¼ˆcell_mappingï¼‰

æ–‡ä»¶åæ ¼å¼ï¼š\*.yamlï¼Œ*ä¸ºæ–‡ä»¶åï¼Œå¯è‡ªå®šä¹‰ã€‚

æ–‡ä»¶å†…å®¹æ ¼å¼ï¼š

```yaml
{cell_name}.{class_name}: {module_name}.{class_name}
```

æ–‡ä»¶å†…å®¹ç¤ºä¾‹ï¼š

```yaml
fc2.Dense: fc2.Linear
conv1.Conv2d: conv3.Conv2d
```

å†’å·å·¦ä¾§ä¸ºMindSporeæ¡†æ¶cellæ¨¡å—çš„{cell_name}.{class_name}ï¼Œå†’å·å³ä¾§ä¸ºPyTorchæ¡†æ¶moduleæ¨¡å—çš„{module_name}.{class_name}ã€‚

```yaml
{cell_name}.{class_name}ä»dump cellæ¨¡å—çº§.npyæ–‡ä»¶åè·å–ï¼Œå‘½åæ ¼å¼ä¸ºï¼š
{Cell}.{cell_name}.{class_name}.{forward/backward}.{index}.{input/output}.{å‚æ•°åºå·/å‚æ•°å}
æˆ–
{Cell}.{cell_name}.{class_name}.parameters_grad.{parameter_name}

{module_name}.{class_name}ä»dump moduleæ¨¡å—çº§.npyæ–‡ä»¶åè·å–ï¼Œå‘½åæ ¼å¼ä¸ºï¼š
{Module}.{module_name}.{class_name}.{forward/backward}.{index}.{input/output}.{å‚æ•°åºå·/å‚æ•°å}
æˆ–
{Module}.{module_name}.{class_name}.parameters_grad.{parameter_name}
```

### 4.5 è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶ï¼ˆdata_mappingï¼‰

æ–‡ä»¶åæ ¼å¼ï¼š\*.yamlï¼Œ*ä¸ºæ–‡ä»¶åï¼Œå¯è‡ªå®šä¹‰ã€‚

æ–‡ä»¶å†…å®¹æ ¼å¼ï¼š

```yaml
# API
{api_type}.{api_name}.{APIè°ƒç”¨æ¬¡æ•°}.{forward/backward}.{input/output}.{å‚æ•°åºå·/å‚æ•°å}: {api_type}.{api_name}.{APIè°ƒç”¨æ¬¡æ•°}.{forward/backward}.{input/output}.{å‚æ•°åºå·/å‚æ•°å}
# æ¨¡å—
{Cell}.{cell_name}.{class_name}.{forward/backward}.{index}.{input/output}.{å‚æ•°åºå·/å‚æ•°å}: {Module}.{module_name}.{class_name}.{forward/backward}.{index}.{input/output}.{å‚æ•°åºå·/å‚æ•°å}
æˆ–
{Cell}.{cell_name}.{class_name}.parameters_grad.{parameter_name}: {Module}.{module_name}.{class_name}.parameters_grad.{parameter_name}
```

å†’å·å·¦ä¾§ä¸ºMindSporeæ¡†æ¶APIçš„åç§°å’ŒCellæ¨¡å—çš„åç§°ï¼Œå†’å·å³ä¾§ä¸ºPyTorchæ¡†æ¶APIçš„åç§°å’Œmoduleæ¨¡å—åç§°ã€‚

APIå’Œæ¨¡å—åç§°è¯·åˆ†åˆ«ä»ã€Š[MindSpore åœºæ™¯çš„ç²¾åº¦æ•°æ®é‡‡é›†](./06.data_dump_MindSpore.md)ã€‹å’Œã€Š[PyTorch åœºæ™¯çš„ç²¾åº¦æ•°æ®é‡‡é›†](./05.data_dump_PyTorch.md)ã€‹ä¸­çš„dump.jsonæ–‡ä»¶è·å–ã€‚

æ–‡ä»¶å†…å®¹ç¤ºä¾‹ï¼š

```yaml
# API
Functional.flash_attention_score.4.forward.input.0: NPU.npu_fusion_attention.4.forward.input.0
# æ¨¡å—
Cell.relu.ReLU.forward.0.input.0: Module.module.language_model.embedding.word_embedding.VocabParallelEmbedding.forward.0.input.0
æˆ–
Cell.relu.ReLU.parameters_grad.weight: Module.module.language_model.embedding.word_embedding.VocabParallelEmbedding.parameters_grad.weight
```

å½“dump.jsonæ–‡ä»¶ä¸­å­˜åœ¨â€œdata_nameâ€å­—æ®µæ—¶ï¼ŒAPIå’Œæ¨¡å—åç§°ä¸ºdata_nameå­—æ®µå»æ‰æ–‡ä»¶åç¼€ï¼Œå¦‚ä¸‹å›¾çº¢æ¡†å¤„æ‰€ç¤ºï¼š

- MindSpore dump

  ![ms_dump](./img/ms_dump.png)

- PyTorch dump

  ![pt_dump](./img/pt_dump.png)

å½“dump.jsonæ–‡ä»¶ä¸­ä¸å­˜åœ¨â€œdata_nameâ€å­—æ®µæ—¶ï¼Œåç§°çš„æ‹¼å†™è§„åˆ™å¦‚ä¸‹ï¼š

input_argsã€input_kwargså’Œoutputä½¿ç”¨ç»Ÿä¸€çš„å‘½åè§„åˆ™ï¼Œå½“å€¼æ˜¯listç±»å‹æ—¶ï¼Œåç§°åé¢æ·»åŠ '.{index}'ï¼Œå½“å€¼ç±»å‹æ˜¯dictç±»å‹æ—¶ï¼Œåç§°åé¢åŠ '.{key}'ï¼Œå½“å€¼ç±»å‹æ˜¯å…·ä½“Tensoræˆ–nullæˆ–ç©ºlist/dictæ—¶ï¼Œå‘½åç»“æŸã€‚

ä»¥ä¸‹é¢cellçš„dumpæ–‡ä»¶ä¸ºä¾‹ï¼š
```yaml
"Cell.network.module.NetworkWithLoss.forward.0": {
  "input_args": [
    {
      "type": "mindspore.Tensor",
      "dtype": "Float32",
      "shape": [
        24,
        16,
        1,
        60,
        34
      ],
      "Max": 3.591925621032715,
      "Min": -3.6856653690338135,
      "Mean": -0.017044123262166977,
      "Norm": 940.671630859375,
      "md5": "00d69ba8"
    },
    {
      "y": {
        "type": "mindspore.Tensor",
        "dtype": "Float32",
        "shape": [
          24,
          1,
          100,
          4096
        ],
        "Max": 2.433350086212158,
        "Min": -4.09375,
        "Mean": -0.00010696164099499583,
        "Norm": 170.3390655517578,
        "md5": "a72e1fa4"
      },
      "y_mask": {
        "type": "mindspore.Tensor",
        "dtype": "Float32",
        "shape": [
          24,
          100
        ],
        "Max": 1.0,
        "Min": 0.0,
        "Mean": 0.22999998927116394,
        "Norm": 23.494680404663086,
        "md5": "bbcbd5ab"
      },
      "x_mask": {
        "type": "mindspore.Tensor",
        "dtype": "Float32",
        "shape": [
          24,
          510
        ],
        "Max": 1.0,
        "Min": 1.0,
        "Mean": 1.0,
        "Norm": 110.63453674316406,
        "md5": "766d1028"
      },
      "loss_mask": {
        "type": "mindspore.Tensor",
        "dtype": "Float32",
        "shape": [
          24,
          1,
          60,
          34
        ],
        "Max": 1.0,
        "Min": 1.0,
        "Mean": 1.0,
        "Norm": 221.26907348632812,
        "md5": "0cb690ce"
      },
      "data_info": {
        "img_hw": null
      }
    }
  ],
"input_kwargs": {},
"output": [
{
"type": "mindspore.Tensor",
"dtype": "Float32",
"shape": [],
"Max": 0.3672327995300293,
"Min": 0.3672327995300293,
"Mean": 0.3672327995300293,
"Norm": 0.3672327995300293,
"md5": "28f8f74f"
}
]
} 
```
,
åˆå§‹åç§°ä¸º`Cell.network.module.NetworkWithLoss.forward.0`ï¼Œ`input_args`æ˜¯`list`ï¼Œé•¿åº¦ä¸º2ï¼ŒæŒ‰ç…§é¡ºåºå‘½åä¸º
```
Cell.network.module.NetworkWithLoss.forward.0.input.0
Cell.network.module.NetworkWithLoss.forward.0.input.1
```
ç¬¬0é¡¹åé¢ç›´æ¥æ˜¯`Tensor`ï¼Œå‘½åç»“æŸ
ç¬¬1é¡¹åé¢æ˜¯`dict`ï¼ŒkeyåŒ…æ‹¬`y`ã€`y_mask`ã€`x_mask`å’Œ`data_info`ï¼Œå‘½åä¸º
```
Cell.network.module.NetworkWithLoss.forward.0.input.1.y
Cell.network.module.NetworkWithLoss.forward.0.input.1.y_mask
Cell.network.module.NetworkWithLoss.forward.0.input.1.x_mask
Cell.network.module.NetworkWithLoss.forward.0.input.1.data_info
```
`y`åé¢æ˜¯`Tensor`ï¼Œå‘½åç»“æŸï¼›`y_mask`åé¢æ˜¯`Tensor`ï¼Œå‘½åç»“æŸï¼›`x_mask`åé¢æ˜¯`Tensor`ï¼Œå‘½åç»“æŸï¼›`data_info`åé¢æ˜¯`dict`ï¼Œkeyæ˜¯`img_hw`ï¼Œå‘½åä¸º
```
Cell.network.module.NetworkWithLoss.forward.0.input.1.data_info.img_hw
```
`img_hw`åé¢æ˜¯`null`ï¼Œå‘½åç»“æŸã€‚

`input_kwargs`æ˜¯`dict`ï¼Œé•¿åº¦ä¸º0ï¼Œå‘½åç»“æŸã€‚
`output`æ˜¯`list`ï¼Œé•¿åº¦ä¸º1ï¼ŒæŒ‰ç…§é¡ºåºå‘½åä¸º
```
Cell.network.module.NetworkWithLoss.forward.0.output.0
```
ç¬¬0é¡¹åé¢æ˜¯`Tensor`ï¼Œå‘½åç»“æŸã€‚

ç»¼ä¸Šï¼Œç”Ÿæˆçš„op_nameä¸ºï¼š
```
Cell.network.module.NetworkWithLoss.forward.0.input.0
Cell.network.module.NetworkWithLoss.forward.0.input.1.y
Cell.network.module.NetworkWithLoss.forward.0.input.1.y_mask
Cell.network.module.NetworkWithLoss.forward.0.input.1.x_mask
Cell.network.module.NetworkWithLoss.forward.0.input.1.data_info.img_hw
Cell.network.module.NetworkWithLoss.forward.0.output.0
```

### 4.6 è‡ªå®šä¹‰æ˜ å°„æ–‡ä»¶ï¼ˆLayer_mappingï¼‰

æ–‡ä»¶åæ ¼å¼ï¼š\*.yamlï¼Œ*ä¸ºæ–‡ä»¶åï¼Œå¯è‡ªå®šä¹‰ã€‚

æ–‡ä»¶å†…å®¹ç¤ºä¾‹ï¼š

```yaml
ParallelAttention:                 # Layerå±‚åç§°
  qkv_proj: query_key_value        # å†’å·å·¦ä¾§ä¸ºMindSporeæ¡†æ¶æ¨¡å‹ä»£ç ä¸­åµŒå¥—çš„Layerå±‚åç§°ï¼Œå†’å·å³ä¾§ä¸ºPyTorchæ¡†æ¶æ¨¡å‹ä»£ç ä¸­åµŒå¥—çš„Layerå±‚åç§°
  out_proj: dense

ParallelTransformerLayer:
  attention: self_attention

Embedding:
  dropout: embedding_dropout

ParallelMLP:
  mapping: dense_h_to_4h
  projection: dense_4h_to_h

PipelineCell:
  model: module

Cell:
  network_with_loss: module
```

Layerå±‚åç§°éœ€è¦ä»æ¨¡å‹ä»£ç ä¸­è·å–ã€‚

yamlæ–‡ä»¶ä¸­åªéœ€é…ç½®MindSporeä¸PyTorchæ¨¡å‹ä»£ç ä¸­åŠŸèƒ½ä¸€è‡´ä½†åç§°ä¸åŒçš„Layerå±‚ï¼Œåç§°ç›¸åŒçš„Layerå±‚ä¼šè¢«è‡ªåŠ¨è¯†åˆ«å¹¶æ˜ å°„ã€‚

æ¨¡å‹ä»£ç ç¤ºä¾‹ï¼š

![ms_dump](./img/ms_layer.png)