# Build the production container

variables:
  - &settings
    registry: codeberg.org
    tags_file: .tags
    target: ${CI_REPO_NAME}
    platforms: linux/amd64,linux/arm64
    # Unfortunately we can only a single build cache image,
    # cf https://codeberg.org/woodpecker-plugins/docker-buildx/pulls/186
    # since codeberg CI is amd64-only let's use the cache for the arm64 platformâ€¦
    cache_from: type=registry,ref=codeberg.org/${CI_REPO_OWNER}/${CI_REPO_NAME}:buildcache-arm64

when:
  event: [ push, pull_request, tag ]
  path: [ "${CI_REPO_NAME}/**/*", pyproject.toml, uv.lock, Dockerfile ]

steps:
  version:
    image: codeberg.org/slidge/woodpecker-version
    pull: true

  build:
    image: woodpeckerci/plugin-docker-buildx
    settings:
      dry_run: true
      <<: *settings
    when:
      event: pull_request

  build-and-push:
    image: woodpeckerci/plugin-docker-buildx
    settings:
      repo: codeberg.org/${CI_REPO_OWNER}/${CI_REPO_NAME}
      username: ${CI_REPO_OWNER}
      password:
        from_secret: CODEBERG_TOKEN
      <<: *settings
    when:
      event: [push, tag]
