image: python:3.10

include: 
  - https://gitlab.com/Linaro/tuxpkg/-/raw/main/gitlab-ci-pipeline.yml

variables:
  TUXPKG_PROJECT: tuxtrigger
  TUXSUITE_TOKEN: $TUXSUITE_TOKEN
  SKIP_BUILD_DEB: 1
  SKIP_BUILD_RPM: 1

.job:
  image: $CI_REGISTRY_IMAGE:ci-debian
  before_script:
  - python3 -m pip install --upgrade isort --break-system-packages
  script:
  - make $CI_JOB_NAME

test:
  extends: .job
  stage: test
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  before_script:
  - python3 -m pip install --upgrade -r requirements-dev.txt --break-system-packages
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

stylecheck:
  extends: .job
  stage: test

typecheck: 
  extends: .job
  stage: test

spellcheck:
  extends: .job
  stage: test

image-build:
  stage: build
  image: docker:20.10.16
  services:
    - name: docker:20.10.16-dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  script:
  - 'docker build -t $CI_REGISTRY_IMAGE/tuxtrigger -f Dockerfile .'
  - 'docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY'
  - 'docker push $CI_REGISTRY_IMAGE/tuxtrigger'
  only:
    refs:
    - main

doc:
  extends: .job
  stage: build
  before_script:
    - python3 -m pip install mkdocs-material --break-system-packages
  script:
  - sh scripts/readme2index.sh docs/index.md
  - mkdocs build
  artifacts:
    paths:
    - public

pages:
  extends: .job
  stage: deploy
  needs:
    - doc
  artifacts:
    paths:
      - public
  only:
    - tags
  script:
  - "true"
