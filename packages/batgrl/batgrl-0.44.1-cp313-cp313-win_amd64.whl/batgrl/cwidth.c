#ifndef _WIN32
    #include <stddef.h>
#endif
#include "cwidth.h"


int cwidth(uint32_t wc) {
    // Character widths as generated by wcwidth.
    // Each item in `CHAR_WIDTHS` represents an interval of ords with common width,
    // i.e., `{0u, 31u, 0u}` means ords 0 through 31 (inclusive) have width 0.
    // Intervals with width 1 are omitted so if an ord doesn't belong to any interval
    // we can assume it has width 1.
    static const uint32_t CHAR_WIDTHS[][3] = {
        {0u, 31u, 0u},
        {127u, 159u, 0u},
        {173u, 173u, 0u},
        {768u, 879u, 0u},
        {1155u, 1161u, 0u},
        {1425u, 1469u, 0u},
        {1471u, 1471u, 0u},
        {1473u, 1474u, 0u},
        {1476u, 1477u, 0u},
        {1479u, 1479u, 0u},
        {1536u, 1541u, 0u},
        {1552u, 1562u, 0u},
        {1564u, 1564u, 0u},
        {1611u, 1631u, 0u},
        {1648u, 1648u, 0u},
        {1750u, 1757u, 0u},
        {1759u, 1764u, 0u},
        {1767u, 1768u, 0u},
        {1770u, 1773u, 0u},
        {1807u, 1807u, 0u},
        {1809u, 1809u, 0u},
        {1840u, 1866u, 0u},
        {1958u, 1968u, 0u},
        {2027u, 2035u, 0u},
        {2045u, 2045u, 0u},
        {2070u, 2073u, 0u},
        {2075u, 2083u, 0u},
        {2085u, 2087u, 0u},
        {2089u, 2093u, 0u},
        {2137u, 2139u, 0u},
        {2192u, 2193u, 0u},
        {2200u, 2207u, 0u},
        {2250u, 2307u, 0u},
        {2362u, 2364u, 0u},
        {2366u, 2383u, 0u},
        {2385u, 2391u, 0u},
        {2402u, 2403u, 0u},
        {2433u, 2435u, 0u},
        {2492u, 2492u, 0u},
        {2494u, 2500u, 0u},
        {2503u, 2504u, 0u},
        {2507u, 2509u, 0u},
        {2519u, 2519u, 0u},
        {2530u, 2531u, 0u},
        {2558u, 2558u, 0u},
        {2561u, 2563u, 0u},
        {2620u, 2620u, 0u},
        {2622u, 2626u, 0u},
        {2631u, 2632u, 0u},
        {2635u, 2637u, 0u},
        {2641u, 2641u, 0u},
        {2672u, 2673u, 0u},
        {2677u, 2677u, 0u},
        {2689u, 2691u, 0u},
        {2748u, 2748u, 0u},
        {2750u, 2757u, 0u},
        {2759u, 2761u, 0u},
        {2763u, 2765u, 0u},
        {2786u, 2787u, 0u},
        {2810u, 2815u, 0u},
        {2817u, 2819u, 0u},
        {2876u, 2876u, 0u},
        {2878u, 2884u, 0u},
        {2887u, 2888u, 0u},
        {2891u, 2893u, 0u},
        {2901u, 2903u, 0u},
        {2914u, 2915u, 0u},
        {2946u, 2946u, 0u},
        {3006u, 3010u, 0u},
        {3014u, 3016u, 0u},
        {3018u, 3021u, 0u},
        {3031u, 3031u, 0u},
        {3072u, 3076u, 0u},
        {3132u, 3132u, 0u},
        {3134u, 3140u, 0u},
        {3142u, 3144u, 0u},
        {3146u, 3149u, 0u},
        {3157u, 3158u, 0u},
        {3170u, 3171u, 0u},
        {3201u, 3203u, 0u},
        {3260u, 3260u, 0u},
        {3262u, 3268u, 0u},
        {3270u, 3272u, 0u},
        {3274u, 3277u, 0u},
        {3285u, 3286u, 0u},
        {3298u, 3299u, 0u},
        {3315u, 3315u, 0u},
        {3328u, 3331u, 0u},
        {3387u, 3388u, 0u},
        {3390u, 3396u, 0u},
        {3398u, 3400u, 0u},
        {3402u, 3405u, 0u},
        {3415u, 3415u, 0u},
        {3426u, 3427u, 0u},
        {3457u, 3459u, 0u},
        {3530u, 3530u, 0u},
        {3535u, 3540u, 0u},
        {3542u, 3542u, 0u},
        {3544u, 3551u, 0u},
        {3570u, 3571u, 0u},
        {3633u, 3633u, 0u},
        {3636u, 3642u, 0u},
        {3655u, 3662u, 0u},
        {3761u, 3761u, 0u},
        {3764u, 3772u, 0u},
        {3784u, 3790u, 0u},
        {3864u, 3865u, 0u},
        {3893u, 3893u, 0u},
        {3895u, 3895u, 0u},
        {3897u, 3897u, 0u},
        {3902u, 3903u, 0u},
        {3953u, 3972u, 0u},
        {3974u, 3975u, 0u},
        {3981u, 3991u, 0u},
        {3993u, 4028u, 0u},
        {4038u, 4038u, 0u},
        {4139u, 4158u, 0u},
        {4182u, 4185u, 0u},
        {4190u, 4192u, 0u},
        {4194u, 4196u, 0u},
        {4199u, 4205u, 0u},
        {4209u, 4212u, 0u},
        {4226u, 4237u, 0u},
        {4239u, 4239u, 0u},
        {4250u, 4253u, 0u},
        {4352u, 4447u, 2u},
        {4448u, 4607u, 0u},
        {4957u, 4959u, 0u},
        {5906u, 5909u, 0u},
        {5938u, 5940u, 0u},
        {5970u, 5971u, 0u},
        {6002u, 6003u, 0u},
        {6068u, 6099u, 0u},
        {6109u, 6109u, 0u},
        {6155u, 6159u, 0u},
        {6277u, 6278u, 0u},
        {6313u, 6313u, 0u},
        {6432u, 6443u, 0u},
        {6448u, 6459u, 0u},
        {6679u, 6683u, 0u},
        {6741u, 6750u, 0u},
        {6752u, 6780u, 0u},
        {6783u, 6783u, 0u},
        {6832u, 6862u, 0u},
        {6912u, 6916u, 0u},
        {6964u, 6980u, 0u},
        {7019u, 7027u, 0u},
        {7040u, 7042u, 0u},
        {7073u, 7085u, 0u},
        {7142u, 7155u, 0u},
        {7204u, 7223u, 0u},
        {7376u, 7378u, 0u},
        {7380u, 7400u, 0u},
        {7405u, 7405u, 0u},
        {7412u, 7412u, 0u},
        {7415u, 7417u, 0u},
        {7616u, 7679u, 0u},
        {8203u, 8207u, 0u},
        {8232u, 8238u, 0u},
        {8288u, 8292u, 0u},
        {8294u, 8303u, 0u},
        {8400u, 8432u, 0u},
        {8986u, 8987u, 2u},
        {9001u, 9002u, 2u},
        {9193u, 9196u, 2u},
        {9200u, 9200u, 2u},
        {9203u, 9203u, 2u},
        {9725u, 9726u, 2u},
        {9748u, 9749u, 2u},
        {9800u, 9811u, 2u},
        {9855u, 9855u, 2u},
        {9875u, 9875u, 2u},
        {9889u, 9889u, 2u},
        {9898u, 9899u, 2u},
        {9917u, 9918u, 2u},
        {9924u, 9925u, 2u},
        {9934u, 9934u, 2u},
        {9940u, 9940u, 2u},
        {9962u, 9962u, 2u},
        {9970u, 9971u, 2u},
        {9973u, 9973u, 2u},
        {9978u, 9978u, 2u},
        {9981u, 9981u, 2u},
        {9989u, 9989u, 2u},
        {9994u, 9995u, 2u},
        {10024u, 10024u, 2u},
        {10060u, 10060u, 2u},
        {10062u, 10062u, 2u},
        {10067u, 10069u, 2u},
        {10071u, 10071u, 2u},
        {10133u, 10135u, 2u},
        {10160u, 10160u, 2u},
        {10175u, 10175u, 2u},
        {11035u, 11036u, 2u},
        {11088u, 11088u, 2u},
        {11093u, 11093u, 2u},
        {11503u, 11505u, 0u},
        {11647u, 11647u, 0u},
        {11744u, 11775u, 0u},
        {11904u, 11929u, 2u},
        {11931u, 12019u, 2u},
        {12032u, 12245u, 2u},
        {12272u, 12329u, 2u},
        {12330u, 12335u, 0u},
        {12336u, 12350u, 2u},
        {12353u, 12438u, 2u},
        {12441u, 12442u, 0u},
        {12443u, 12543u, 2u},
        {12549u, 12591u, 2u},
        {12593u, 12686u, 2u},
        {12688u, 12771u, 2u},
        {12783u, 12830u, 2u},
        {12832u, 12871u, 2u},
        {12880u, 19903u, 2u},
        {19968u, 42124u, 2u},
        {42128u, 42182u, 2u},
        {42607u, 42610u, 0u},
        {42612u, 42621u, 0u},
        {42654u, 42655u, 0u},
        {42736u, 42737u, 0u},
        {43010u, 43010u, 0u},
        {43014u, 43014u, 0u},
        {43019u, 43019u, 0u},
        {43043u, 43047u, 0u},
        {43052u, 43052u, 0u},
        {43136u, 43137u, 0u},
        {43188u, 43205u, 0u},
        {43232u, 43249u, 0u},
        {43263u, 43263u, 0u},
        {43302u, 43309u, 0u},
        {43335u, 43347u, 0u},
        {43360u, 43388u, 2u},
        {43392u, 43395u, 0u},
        {43443u, 43456u, 0u},
        {43493u, 43493u, 0u},
        {43561u, 43574u, 0u},
        {43587u, 43587u, 0u},
        {43596u, 43597u, 0u},
        {43643u, 43645u, 0u},
        {43696u, 43696u, 0u},
        {43698u, 43700u, 0u},
        {43703u, 43704u, 0u},
        {43710u, 43711u, 0u},
        {43713u, 43713u, 0u},
        {43755u, 43759u, 0u},
        {43765u, 43766u, 0u},
        {44003u, 44010u, 0u},
        {44012u, 44013u, 0u},
        {44032u, 55203u, 2u},
        {55216u, 55295u, 0u},
        {63744u, 64255u, 2u},
        {64286u, 64286u, 0u},
        {65024u, 65039u, 0u},
        {65040u, 65049u, 2u},
        {65056u, 65071u, 0u},
        {65072u, 65106u, 2u},
        {65108u, 65126u, 2u},
        {65128u, 65131u, 2u},
        {65279u, 65279u, 0u},
        {65281u, 65376u, 2u},
        {65504u, 65510u, 2u},
        {65529u, 65531u, 0u},
        {66045u, 66045u, 0u},
        {66272u, 66272u, 0u},
        {66422u, 66426u, 0u},
        {68097u, 68099u, 0u},
        {68101u, 68102u, 0u},
        {68108u, 68111u, 0u},
        {68152u, 68154u, 0u},
        {68159u, 68159u, 0u},
        {68325u, 68326u, 0u},
        {68900u, 68903u, 0u},
        {69291u, 69292u, 0u},
        {69373u, 69375u, 0u},
        {69446u, 69456u, 0u},
        {69506u, 69509u, 0u},
        {69632u, 69634u, 0u},
        {69688u, 69702u, 0u},
        {69744u, 69744u, 0u},
        {69747u, 69748u, 0u},
        {69759u, 69762u, 0u},
        {69808u, 69818u, 0u},
        {69821u, 69821u, 0u},
        {69826u, 69826u, 0u},
        {69837u, 69837u, 0u},
        {69888u, 69890u, 0u},
        {69927u, 69940u, 0u},
        {69957u, 69958u, 0u},
        {70003u, 70003u, 0u},
        {70016u, 70018u, 0u},
        {70067u, 70080u, 0u},
        {70089u, 70092u, 0u},
        {70094u, 70095u, 0u},
        {70188u, 70199u, 0u},
        {70206u, 70206u, 0u},
        {70209u, 70209u, 0u},
        {70367u, 70378u, 0u},
        {70400u, 70403u, 0u},
        {70459u, 70460u, 0u},
        {70462u, 70468u, 0u},
        {70471u, 70472u, 0u},
        {70475u, 70477u, 0u},
        {70487u, 70487u, 0u},
        {70498u, 70499u, 0u},
        {70502u, 70508u, 0u},
        {70512u, 70516u, 0u},
        {70709u, 70726u, 0u},
        {70750u, 70750u, 0u},
        {70832u, 70851u, 0u},
        {71087u, 71093u, 0u},
        {71096u, 71104u, 0u},
        {71132u, 71133u, 0u},
        {71216u, 71232u, 0u},
        {71339u, 71351u, 0u},
        {71453u, 71467u, 0u},
        {71724u, 71738u, 0u},
        {71984u, 71989u, 0u},
        {71991u, 71992u, 0u},
        {71995u, 71998u, 0u},
        {72000u, 72000u, 0u},
        {72002u, 72003u, 0u},
        {72145u, 72151u, 0u},
        {72154u, 72160u, 0u},
        {72164u, 72164u, 0u},
        {72193u, 72202u, 0u},
        {72243u, 72249u, 0u},
        {72251u, 72254u, 0u},
        {72263u, 72263u, 0u},
        {72273u, 72283u, 0u},
        {72330u, 72345u, 0u},
        {72751u, 72758u, 0u},
        {72760u, 72767u, 0u},
        {72850u, 72871u, 0u},
        {72873u, 72886u, 0u},
        {73009u, 73014u, 0u},
        {73018u, 73018u, 0u},
        {73020u, 73021u, 0u},
        {73023u, 73029u, 0u},
        {73031u, 73031u, 0u},
        {73098u, 73102u, 0u},
        {73104u, 73105u, 0u},
        {73107u, 73111u, 0u},
        {73459u, 73462u, 0u},
        {73472u, 73473u, 0u},
        {73475u, 73475u, 0u},
        {73524u, 73530u, 0u},
        {73534u, 73538u, 0u},
        {78896u, 78912u, 0u},
        {78919u, 78933u, 0u},
        {92912u, 92916u, 0u},
        {92976u, 92982u, 0u},
        {94031u, 94031u, 0u},
        {94033u, 94087u, 0u},
        {94095u, 94098u, 0u},
        {94176u, 94179u, 2u},
        {94180u, 94180u, 0u},
        {94192u, 94193u, 0u},
        {94208u, 100343u, 2u},
        {100352u, 101589u, 2u},
        {101632u, 101640u, 2u},
        {110576u, 110579u, 2u},
        {110581u, 110587u, 2u},
        {110589u, 110590u, 2u},
        {110592u, 110882u, 2u},
        {110898u, 110898u, 2u},
        {110928u, 110930u, 2u},
        {110933u, 110933u, 2u},
        {110948u, 110951u, 2u},
        {110960u, 111355u, 2u},
        {113821u, 113822u, 0u},
        {113824u, 113827u, 0u},
        {118528u, 118573u, 0u},
        {118576u, 118598u, 0u},
        {119141u, 119145u, 0u},
        {119149u, 119170u, 0u},
        {119173u, 119179u, 0u},
        {119210u, 119213u, 0u},
        {119362u, 119364u, 0u},
        {121344u, 121398u, 0u},
        {121403u, 121452u, 0u},
        {121461u, 121461u, 0u},
        {121476u, 121476u, 0u},
        {121499u, 121503u, 0u},
        {121505u, 121519u, 0u},
        {122880u, 122886u, 0u},
        {122888u, 122904u, 0u},
        {122907u, 122913u, 0u},
        {122915u, 122916u, 0u},
        {122918u, 122922u, 0u},
        {123023u, 123023u, 0u},
        {123184u, 123190u, 0u},
        {123566u, 123566u, 0u},
        {123628u, 123631u, 0u},
        {124140u, 124143u, 0u},
        {125136u, 125142u, 0u},
        {125252u, 125258u, 0u},
        {126980u, 126980u, 2u},
        {127183u, 127183u, 2u},
        {127374u, 127374u, 2u},
        {127377u, 127386u, 2u},
        {127488u, 127490u, 2u},
        {127504u, 127547u, 2u},
        {127552u, 127560u, 2u},
        {127568u, 127569u, 2u},
        {127584u, 127589u, 2u},
        {127744u, 127776u, 2u},
        {127789u, 127797u, 2u},
        {127799u, 127868u, 2u},
        {127870u, 127891u, 2u},
        {127904u, 127946u, 2u},
        {127951u, 127955u, 2u},
        {127968u, 127984u, 2u},
        {127988u, 127988u, 2u},
        {127992u, 127994u, 2u},
        {127995u, 127999u, 0u},
        {128000u, 128062u, 2u},
        {128064u, 128064u, 2u},
        {128066u, 128252u, 2u},
        {128255u, 128317u, 2u},
        {128331u, 128334u, 2u},
        {128336u, 128359u, 2u},
        {128378u, 128378u, 2u},
        {128405u, 128406u, 2u},
        {128420u, 128420u, 2u},
        {128507u, 128591u, 2u},
        {128640u, 128709u, 2u},
        {128716u, 128716u, 2u},
        {128720u, 128722u, 2u},
        {128725u, 128727u, 2u},
        {128732u, 128735u, 2u},
        {128747u, 128748u, 2u},
        {128756u, 128764u, 2u},
        {128992u, 129003u, 2u},
        {129008u, 129008u, 2u},
        {129292u, 129338u, 2u},
        {129340u, 129349u, 2u},
        {129351u, 129535u, 2u},
        {129648u, 129660u, 2u},
        {129664u, 129672u, 2u},
        {129680u, 129725u, 2u},
        {129727u, 129733u, 2u},
        {129742u, 129755u, 2u},
        {129760u, 129768u, 2u},
        {129776u, 129784u, 2u},
        {131072u, 196605u, 2u},
        {196608u, 262141u, 2u},
        {917505u, 917505u, 0u},
        {917536u, 917631u, 0u},
        {917760u, 917999u, 0u},
    };
    static const size_t CHAR_WIDTHS_LEN = sizeof(CHAR_WIDTHS) / sizeof(int[3]);

    size_t lo = 0, hi = CHAR_WIDTHS_LEN, mid;
    while(lo < hi) {
        mid = (lo + hi) / 2;
        if(wc < CHAR_WIDTHS[mid][0]) hi = mid;
        else if(wc > CHAR_WIDTHS[mid][1]) lo = mid + 1;
        else return CHAR_WIDTHS[mid][2];
    }
    return 1;
}
