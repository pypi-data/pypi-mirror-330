const V=["BOOLEAN","INT32","INT64","INT96","FLOAT","DOUBLE","BYTE_ARRAY","FIXED_LEN_BYTE_ARRAY"],b=["PLAIN",void 0,"PLAIN_DICTIONARY","RLE","BIT_PACKED","DELTA_BINARY_PACKED","DELTA_LENGTH_BYTE_ARRAY","DELTA_BYTE_ARRAY","RLE_DICTIONARY","BYTE_STREAM_SPLIT"],we=["REQUIRED","OPTIONAL","REPEATED"],ge=["UTF8","MAP","MAP_KEY_VALUE","LIST","ENUM","DECIMAL","DATE","TIME_MILLIS","TIME_MICROS","TIMESTAMP_MILLIS","TIMESTAMP_MICROS","UINT_8","UINT_16","UINT_32","UINT_64","INT_8","INT_16","INT_32","INT_64","JSON","BSON","INTERVAL"],ye=["UNCOMPRESSED","SNAPPY","GZIP","LZO","BROTLI","LZ4","ZSTD","LZ4_RAW"],G=["DATA_PAGE","INDEX_PAGE","DICTIONARY_PAGE","DATA_PAGE_V2"],j=864e5;function Q(e,t,n,r,i=!0){if(t&&r.endsWith("_DICTIONARY")){t=X(t,n,i);let f=e;e instanceof Uint8Array&&!(t instanceof Uint8Array)&&(f=new t.constructor(e.length));for(let o=0;o<e.length;o++)f[o]=t[e[o]];return f}else return X(e,n,i)}function X(e,t,n=!0){var i,f;const r=t.converted_type;if(r==="DECIMAL"){const o=t.scale||0,l=Math.pow(10,-o),s=new Array(e.length);for(let a=0;a<s.length;a++)e[0]instanceof Uint8Array?s[a]=Z(e[a])*l:s[a]=Number(e[a])*l;return s}if(r===void 0&&t.type==="INT96")return Array.from(e).map(me);if(r==="DATE"){const o=new Array(e.length);for(let l=0;l<o.length;l++)o[l]=new Date(e[l]*j);return o}if(r==="TIMESTAMP_MILLIS"){const o=new Array(e.length);for(let l=0;l<o.length;l++)o[l]=new Date(Number(e[l]));return o}if(r==="TIMESTAMP_MICROS"){const o=new Array(e.length);for(let l=0;l<o.length;l++)o[l]=new Date(Number(e[l]/1000n));return o}if(r==="JSON"){const o=new TextDecoder;return e.map(l=>JSON.parse(o.decode(l)))}if(r==="BSON")throw new Error("parquet bson not supported");if(r==="INTERVAL")throw new Error("parquet interval not supported");if(r==="UTF8"||n&&t.type==="BYTE_ARRAY"){const o=new TextDecoder,l=new Array(e.length);for(let s=0;s<l.length;s++)l[s]=e[s]&&o.decode(e[s]);return l}if(r==="UINT_64"){const o=new BigUint64Array(e.length);for(let l=0;l<o.length;l++)o[l]=BigInt(e[l]);return o}if(((i=t.logical_type)==null?void 0:i.type)==="FLOAT16")return Array.from(e).map(H);if(((f=t.logical_type)==null?void 0:f.type)==="TIMESTAMP"){const{unit:o}=t.logical_type;let l=1n;o==="MICROS"&&(l=1000n),o==="NANOS"&&(l=1000000n);const s=new Array(e.length);for(let a=0;a<s.length;a++)s[a]=new Date(Number(e[a]/l));return s}return e}function Z(e){let t=0;for(const n of e)t=t<<8|n;return t}function me(e){const t=Number((e>>64n)-2440588n),n=Number((e&0xffffffffffffffffn)/1000000n),r=t*j+n;return new Date(r)}function H(e){if(!e)return;const t=e[1]<<8|e[0],n=t>>15?-1:1,r=t>>10&31,i=t&1023;return r===0?n*Math.pow(2,-14)*(i/1024):r===31?i?NaN:n*(1/0):n*Math.pow(2,r-15)*(1+i/1024)}function J(e,t,n){const r=e[t],i=[];let f=1;if(r.num_children)for(;i.length<r.num_children;){const o=e[t+f],l=J(e,t+f,[...n,o.name]);f+=l.count,i.push(l)}return{count:f,element:r,children:i,path:n}}function W(e,t){let n=J(e,0,[]);const r=[n];for(const i of t){const f=n.children.find(o=>o.element.name===i);if(!f)throw new Error(`parquet schema element not found: ${t}`);r.push(f),n=f}return r}function K(e){let t=0;for(const{element:n}of e)n.repetition_type==="REPEATED"&&t++;return t}function D(e){let t=0;for(const{element:n}of e.slice(1))n.repetition_type!=="REQUIRED"&&t++;return t}function Ee(e){if(!e||e.element.converted_type!=="LIST"||e.children.length>1)return!1;const t=e.children[0];return!(t.children.length>1||t.element.repetition_type!=="REPEATED")}function Ae(e){var n,r;if(!e||e.element.converted_type!=="MAP"||e.children.length>1)return!1;const t=e.children[0];return!(t.children.length!==2||t.element.repetition_type!=="REPEATED"||((n=t.children.find(i=>i.element.name==="key"))==null?void 0:n.element.repetition_type)==="REPEATED"||((r=t.children.find(i=>i.element.name==="value"))==null?void 0:r.element.repetition_type)==="REPEATED")}const m={STOP:0,TRUE:1,FALSE:2,BYTE:3,I16:4,I32:5,I64:6,DOUBLE:7,BINARY:8,LIST:9,SET:10,MAP:11,STRUCT:12,UUID:13};function ee(e){let t=0;const n={};for(;e.offset<e.view.byteLength;){const[r,i,f]=ne(e,t);if(t=f,r===m.STOP)break;n[`field_${i}`]=O(e,r)}return n}function O(e,t){switch(t){case m.TRUE:return!0;case m.FALSE:return!1;case m.BYTE:return e.view.getInt8(e.offset++);case m.I16:case m.I32:return Te(e);case m.I64:return q(e);case m.DOUBLE:{const n=e.view.getFloat64(e.offset,!0);return e.offset+=8,n}case m.BINARY:{const n=L(e),r=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,n);return e.offset+=n,r}case m.LIST:{const[n,r]=ve(e),i=n===m.TRUE||n===m.FALSE,f=new Array(r);for(let o=0;o<r;o++)f[o]=i?O(e,m.BYTE)===1:O(e,n);return f}case m.STRUCT:{const n={};let r=0;for(;;){let i,f;if([i,f,r]=ne(e,r),i===m.STOP)break;n[`field_${f}`]=O(e,i)}return n}case m.UUID:{let n="";for(let r=0;r<16;r++)n+=e.view.getUint8(e.offset++).toString(16).padStart(2,"0");return n}default:throw new Error(`thrift unhandled type: ${t}`)}}function L(e){let t=0,n=0;for(;;){const r=e.view.getUint8(e.offset++);if(t|=(r&127)<<n,!(r&128))return t;n+=7}}function Ie(e){let t=0n,n=0n;for(;;){const r=e.view.getUint8(e.offset++);if(t|=BigInt(r&127)<<n,!(r&128))return t;n+=7n}}function Te(e){const t=L(e);return t>>>1^-(t&1)}function q(e){const t=Ie(e);return t>>BigInt(1)^-(t&BigInt(1))}function te(e){return e&15}function ne(e,t){const n=e.view.getUint8(e.offset++);if((n&15)===m.STOP)return[0,0,t];const r=n>>4;let i;if(r)i=t+r;else throw new Error("non-delta field id not supported");return[te(n),i,i]}function ve(e){const t=e.view.getUint8(e.offset++),n=t>>4,r=te(t);if(n===15){const i=L(e);return[r,i]}return[r,n]}async function re(e,t=1<<19){if(!e)throw new Error("parquet file is required");if(!(e.byteLength>=0))throw new Error("parquet file byteLength is required");const n=Math.max(0,e.byteLength-t),r=await e.slice(n,e.byteLength),i=new DataView(r);if(i.getUint32(r.byteLength-4,!0)!==827474256)throw new Error("parquet file invalid (footer != PAR1)");const f=i.getUint32(r.byteLength-8,!0);if(f>e.byteLength-8)throw new Error(`parquet metadata length ${f} exceeds available buffer ${e.byteLength-8}`);if(f+8>t){const o=e.byteLength-f-8,l=await e.slice(o,n),s=new ArrayBuffer(f+8),a=new Uint8Array(s);return a.set(new Uint8Array(l)),a.set(new Uint8Array(r),n-o),Y(s)}else return Y(r)}function Y(e){var _;if(!e)throw new Error("parquet file is required");const t=new DataView(e);if(t.byteLength<8)throw new Error("parquet file is too short");if(t.getUint32(t.byteLength-4,!0)!==827474256)throw new Error("parquet file invalid (footer != PAR1)");const n=t.byteLength-8,r=t.getUint32(n,!0);if(r>t.byteLength-8)throw new Error(`parquet metadata length ${r} exceeds available buffer ${t.byteLength-8}`);const i=n-r,f=ee({view:t,offset:i}),o=new TextDecoder;function l(u){return u&&o.decode(u)}const s=f.field_1,a=f.field_2.map(u=>({type:V[u.field_1],type_length:u.field_2,repetition_type:we[u.field_3],name:l(u.field_4),num_children:u.field_5,converted_type:ge[u.field_6],scale:u.field_7,precision:u.field_8,field_id:u.field_9,logical_type:be(u.field_10)})),h=a.filter(u=>u.type),p=f.field_3,g=f.field_4.map(u=>{var y;return{columns:u.field_1.map((d,E)=>{var I,T;return{file_path:l(d.field_1),file_offset:d.field_2,meta_data:d.field_3&&{type:V[d.field_3.field_1],encodings:(I=d.field_3.field_2)==null?void 0:I.map(A=>b[A]),path_in_schema:d.field_3.field_3.map(l),codec:ye[d.field_3.field_4],num_values:d.field_3.field_5,total_uncompressed_size:d.field_3.field_6,total_compressed_size:d.field_3.field_7,key_value_metadata:d.field_3.field_8,data_page_offset:d.field_3.field_9,index_page_offset:d.field_3.field_10,dictionary_page_offset:d.field_3.field_11,statistics:Le(d.field_3.field_12,h[E]),encoding_stats:(T=d.field_3.field_13)==null?void 0:T.map(A=>({page_type:G[A.field_1],encoding:b[A.field_2],count:A.field_3})),bloom_filter_offset:d.field_3.field_14,bloom_filter_length:d.field_3.field_15,size_statistics:d.field_3.field_16&&{unencoded_byte_array_data_bytes:d.field_3.field_16.field_1,repetition_level_histogram:d.field_3.field_16.field_2,definition_level_histogram:d.field_3.field_16.field_3}},offset_index_offset:d.field_4,offset_index_length:d.field_5,column_index_offset:d.field_6,column_index_length:d.field_7,crypto_metadata:d.field_7,encrypted_column_metadata:d.field_8}}),total_byte_size:u.field_2,num_rows:u.field_3,sorting_columns:(y=u.field_4)==null?void 0:y.map(d=>({column_idx:d.field_1,descending:d.field_2,nulls_first:d.field_3})),file_offset:u.field_5,total_compressed_size:u.field_6,ordinal:u.field_7}}),w=(_=f.field_5)==null?void 0:_.map(u=>({key:l(u.field_1),value:l(u.field_2)})),c=l(f.field_6);return{version:s,schema:a,num_rows:p,row_groups:g,key_value_metadata:w,created_by:c,metadata_length:r}}function be(e){return e!=null&&e.field_1?{type:"STRING"}:e!=null&&e.field_2?{type:"MAP"}:e!=null&&e.field_3?{type:"LIST"}:e!=null&&e.field_4?{type:"ENUM"}:e!=null&&e.field_5?{type:"DECIMAL",scale:e.field_5.field_1,precision:e.field_5.field_2}:e!=null&&e.field_6?{type:"DATE"}:e!=null&&e.field_7?{type:"TIME",isAdjustedToUTC:e.field_7.field_1,unit:ie(e.field_7.field_2)}:e!=null&&e.field_8?{type:"TIMESTAMP",isAdjustedToUTC:e.field_8.field_1,unit:ie(e.field_8.field_2)}:e!=null&&e.field_10?{type:"INTEGER",bitWidth:e.field_10.field_1,isSigned:e.field_10.field_2}:e!=null&&e.field_11?{type:"NULL"}:e!=null&&e.field_12?{type:"JSON"}:e!=null&&e.field_13?{type:"BSON"}:e!=null&&e.field_14?{type:"UUID"}:e!=null&&e.field_15?{type:"FLOAT16"}:e}function ie(e){if(e.field_1)return"MILLIS";if(e.field_2)return"MICROS";if(e.field_3)return"NANOS";throw new Error("parquet time unit required")}function Le(e,t){return e&&{max:U(e.field_1,t),min:U(e.field_2,t),null_count:e.field_3,distinct_count:e.field_4,max_value:U(e.field_5,t),min_value:U(e.field_6,t),is_max_value_exact:e.field_7,is_min_value_exact:e.field_8}}function U(e,t){const{type:n,converted_type:r,logical_type:i}=t;if(e===void 0)return e;if(n==="BOOLEAN")return e[0]===1;if(n==="BYTE_ARRAY")return new TextDecoder().decode(e);const f=new DataView(e.buffer,e.byteOffset,e.byteLength);return n==="FLOAT"&&f.byteLength===4?f.getFloat32(0,!0):n==="DOUBLE"&&f.byteLength===8?f.getFloat64(0,!0):n==="INT32"&&r==="DATE"?new Date(f.getInt32(0,!0)*864e5):n==="INT64"&&r==="TIMESTAMP_MICROS"?new Date(Number(f.getBigInt64(0,!0)/1000n)):n==="INT64"&&r==="TIMESTAMP_MILLIS"?new Date(Number(f.getBigInt64(0,!0))):n==="INT64"&&(i==null?void 0:i.type)==="TIMESTAMP"?new Date(Number(f.getBigInt64(0,!0))):n==="INT32"&&f.byteLength===4?f.getInt32(0,!0):n==="INT64"&&f.byteLength===8?f.getBigInt64(0,!0):r==="DECIMAL"?Z(e)*Math.pow(10,-(t.scale||0)):(i==null?void 0:i.type)==="FLOAT16"?H(e):e}function fe(e,t,n,r,i,f){const o=(t==null?void 0:t.length)||n.length;let l=0;const s=[e];let a=e,h=0,p=0,g=0;if(n[0])for(;h<i.length-2&&g<n[0];)a=a.at(-1),s.push(a),h++,i[h]!=="REQUIRED"&&p++,i[h]==="REPEATED"&&g++;for(let w=0;w<o;w++){const c=t!=null&&t.length?t[w]:f,_=n[w];for(;h&&(_<g||i[h]!=="REPEATED");)i[h]!=="REQUIRED"&&(s.pop(),p--),i[h]==="REPEATED"&&g--,h--;for(a=s.at(-1);(h<i.length-2||i[h+1]==="REPEATED")&&(p<c||i[h+1]==="REQUIRED");){if(h++,i[h]!=="REQUIRED"){const u=[];a.push(u),a=u,s.push(u),p++}i[h]==="REPEATED"&&g++}c===f?a.push(r[l++]):h===i.length-2?a.push(null):a.push([])}if(!e.length)for(let w=0;w<f;w++){const c=[];a.push(c),a=c}return e}function R(e,t,n=0){const r=t.path.join("."),i=t.element.repetition_type==="OPTIONAL",f=i?n+1:n;if(Ee(t)){let o=t.children[0],l=f;o.children.length===1&&(o=o.children[0],l++),R(e,o,l);const s=o.path.join("."),a=e.get(s);if(!a)throw new Error("parquet list column missing values");i&&P(a,n),e.set(r,a),e.delete(s);return}if(Ae(t)){const o=t.children[0].element.name;R(e,t.children[0].children[0],f+1),R(e,t.children[0].children[1],f+1);const l=e.get(`${r}.${o}.key`),s=e.get(`${r}.${o}.value`);if(!l)throw new Error("parquet map column missing keys");if(!s)throw new Error("parquet map column missing values");if(l.length!==s.length)throw new Error("parquet map column key/value length mismatch");const a=oe(l,s,f);i&&P(a,n),e.delete(`${r}.${o}.key`),e.delete(`${r}.${o}.value`),e.set(r,a);return}if(t.children.length){const o=t.element.repetition_type==="REQUIRED"?n:n+1,l={};for(const a of t.children){R(e,a,o);const h=e.get(a.path.join("."));if(!h)throw new Error("parquet struct missing child data");l[a.element.name]=h}for(const a of t.children)e.delete(a.path.join("."));const s=le(l,o);i&&P(s,n),e.set(r,s)}}function P(e,t){for(let n=0;n<e.length;n++)t?P(e[n],t-1):e[n]=e[n][0]}function oe(e,t,n){const r=[];for(let i=0;i<e.length;i++)if(n)r.push(oe(e[i],t[i],n-1));else if(e[i]){const f={};for(let o=0;o<e[i].length;o++){const l=t[i][o];f[e[i][o]]=l===void 0?null:l}r.push(f)}else r.push(void 0);return r}function le(e,t){var f;const n=Object.keys(e),r=(f=e[n[0]])==null?void 0:f.length,i=[];for(let o=0;o<r;o++){const l={};for(const s of n){if(e[s].length!==r)throw new Error("parquet struct parsing error");l[s]=e[s][o]}t?i.push(le(l,t-1)):i.push(l)}return i}function S(e){return 32-Math.clz32(e)}function N(e,t,n,r){n||(e.offset+=4);let i=0;for(;i<r.length;){const f=L(e);if(f&1)i=Re(e,f,t,r,i);else{const o=f>>>1;Ne(e,o,t,r,i),i+=o}}}function Ne(e,t,n,r,i){const f=n+7>>3;let o=0;for(let l=0;l<f;l++)o|=e.view.getUint8(e.offset++)<<(l<<3);for(let l=0;l<t;l++)r[i+l]=o}function Re(e,t,n,r,i){let f=t>>1<<3;const o=(1<<n)-1;let l=0;if(e.offset<e.view.byteLength)l=e.view.getUint8(e.offset++);else if(o)throw new Error(`parquet bitpack offset ${e.offset} out of range`);let s=8,a=0;for(;f;)a>8?(a-=8,s-=8,l>>>=8):s-a<n?(l|=e.view.getUint8(e.offset)<<s,e.offset++,s+=8):(i<r.length&&(r[i++]=l>>a&o),f--,a+=n);return i}function se(e,t,n,r){const i=De(n,r),f=new Uint8Array(t*i);for(let o=0;o<i;o++)for(let l=0;l<t;l++)f[l*i+o]=e.view.getUint8(e.offset++);if(n==="FLOAT")return new Float32Array(f.buffer);if(n==="DOUBLE")return new Float64Array(f.buffer);if(n==="INT32")return new Int32Array(f.buffer);if(n==="INT64")return new BigInt64Array(f.buffer);if(n==="FIXED_LEN_BYTE_ARRAY"){const o=new Array(t);for(let l=0;l<t;l++)o[l]=f.subarray(l*i,(l+1)*i);return o}throw new Error(`parquet byte_stream_split unsupported type: ${n}`)}function De(e,t){switch(e){case"INT32":case"FLOAT":return 4;case"INT64":case"DOUBLE":return 8;case"FIXED_LEN_BYTE_ARRAY":if(!t)throw new Error("parquet byteWidth missing type_length");return t;default:throw new Error(`parquet unsupported type: ${e}`)}}function $(e,t,n,r){if(n===0)return[];if(t==="BOOLEAN")return Oe(e,n);if(t==="INT32")return Ue(e,n);if(t==="INT64")return Pe(e,n);if(t==="INT96")return Se(e,n);if(t==="FLOAT")return Me(e,n);if(t==="DOUBLE")return Be(e,n);if(t==="BYTE_ARRAY")return qe(e,n);if(t==="FIXED_LEN_BYTE_ARRAY"){if(!r)throw new Error("parquet missing fixed length");return Ye(e,n,r)}else throw new Error(`parquet unhandled type: ${t}`)}function Oe(e,t){const n=new Array(t);for(let r=0;r<t;r++){const i=e.offset+(r/8|0),f=r%8,o=e.view.getUint8(i);n[r]=(o&1<<f)!==0}return e.offset+=Math.ceil(t/8),n}function Ue(e,t){const n=(e.view.byteOffset+e.offset)%4?new Int32Array(M(e.view.buffer,e.view.byteOffset+e.offset,t*4)):new Int32Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*4,n}function Pe(e,t){const n=(e.view.byteOffset+e.offset)%8?new BigInt64Array(M(e.view.buffer,e.view.byteOffset+e.offset,t*8)):new BigInt64Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*8,n}function Se(e,t){const n=new Array(t);for(let r=0;r<t;r++){const i=e.view.getBigInt64(e.offset+r*12,!0),f=e.view.getInt32(e.offset+r*12+8,!0);n[r]=BigInt(f)<<64n|i}return e.offset+=t*12,n}function Me(e,t){const n=(e.view.byteOffset+e.offset)%4?new Float32Array(M(e.view.buffer,e.view.byteOffset+e.offset,t*4)):new Float32Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*4,n}function Be(e,t){const n=(e.view.byteOffset+e.offset)%8?new Float64Array(M(e.view.buffer,e.view.byteOffset+e.offset,t*8)):new Float64Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*8,n}function qe(e,t){const n=new Array(t);for(let r=0;r<t;r++){const i=e.view.getInt32(e.offset,!0);e.offset+=4,n[r]=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,i),e.offset+=i}return n}function Ye(e,t,n){const r=new Array(t);for(let i=0;i<t;i++)r[i]=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,n),e.offset+=n;return r}function M(e,t,n){const r=new ArrayBuffer(n);return new Uint8Array(r).set(new Uint8Array(e,t,n)),r}const $e=[0,255,65535,16777215,4294967295];function Ce(e,t,n,r,i){for(let f=0;f<i;f++)n[r+f]=e[t+f]}function Fe(e,t,n,r){for(let i=0;i<r;i++)e[t+i]=e[t-n+i]}function ae(e,t){const n=e.byteLength,r=t.byteLength;let i=0,f=0;for(;i<n;){const o=e[i];if(i++,o<128)break}if(r&&i>=n)throw new Error("invalid snappy length header");for(;i<n;){const o=e[i];let l=0;if(i++,i>=n)throw new Error("missing eof marker");if(o&3){let s=0;switch(o&3){case 1:l=(o>>>2&7)+4,s=e[i]+(o>>>5<<8),i++;break;case 2:if(n<=i+1)throw new Error("snappy error end of input");l=(o>>>2)+1,s=e[i]+(e[i+1]<<8),i+=2;break;case 3:if(n<=i+3)throw new Error("snappy error end of input");l=(o>>>2)+1,s=e[i]+(e[i+1]<<8)+(e[i+2]<<16)+(e[i+3]<<24),i+=4;break}if(s===0||isNaN(s))throw new Error(`invalid offset ${s} pos ${i} inputLength ${n}`);if(s>f)throw new Error("cannot copy from before start of buffer");Fe(t,f,s,l),f+=l}else{let s=(o>>>2)+1;if(s>60){if(i+3>=n)throw new Error("snappy error literal pos + 3 >= inputLength");const a=s-60;s=e[i]+(e[i+1]<<8)+(e[i+2]<<16)+(e[i+3]<<24),s=(s&$e[a])+1,i+=a}if(i+s>n)throw new Error("snappy error literal exceeds input length");Ce(e,i,t,f,s),i+=s,f+=s}}if(f!==r)throw new Error("premature end of input")}function xe(e,t,n,{type:r}){const i=new DataView(e.buffer,e.byteOffset,e.byteLength),f={view:i,offset:0};let o;const l=ze(f,t,n),{definitionLevels:s,numNulls:a}=Ve(f,t,n),h=t.num_values-a;if(t.encoding==="PLAIN"){const{type_length:p}=n[n.length-1].element;o=$(f,r,h,p)}else if(t.encoding==="PLAIN_DICTIONARY"||t.encoding==="RLE_DICTIONARY"||t.encoding==="RLE"){const p=r==="BOOLEAN"?1:i.getUint8(f.offset++);p?(o=new Array(h),N(f,p,i.byteLength-f.offset,o)):o=new Uint8Array(h)}else if(t.encoding==="BYTE_STREAM_SPLIT"){const{type_length:p}=n[n.length-1].element;o=se(f,h,r,p)}else throw new Error(`parquet unsupported encoding: ${t.encoding}`);return{definitionLevels:s,repetitionLevels:l,dataPage:o}}function ke(e,t,n,r){const i={view:new DataView(e.buffer,e.byteOffset,e.byteLength),offset:0};return $(i,n.type,t.num_values,r)}function ze(e,t,n){if(n.length>1){const r=K(n);if(r){const i=new Array(t.num_values);return N(e,S(r),0,i),i}}return[]}function Ve(e,t,n){const r=D(n);if(!r)return{definitionLevels:[],numNulls:0};const i=new Array(t.num_values);N(e,S(r),0,i);let f=t.num_values;for(const o of i)o===r&&f--;return f===0&&(i.length=0),{definitionLevels:i,numNulls:f}}function C(e,t,n,r){let i;const f=r==null?void 0:r[n];if(n==="UNCOMPRESSED")i=e;else if(f)i=f(e,t);else if(n==="SNAPPY")i=new Uint8Array(t),ae(e,i);else throw new Error(`parquet unsupported compression codec: ${n}`);if((i==null?void 0:i.length)!==t)throw new Error(`parquet decompressed page length ${i==null?void 0:i.length} does not match header ${t}`);return i}function B(e,t,n){const r=n instanceof Int32Array,i=L(e),f=L(e);L(e);let o=q(e),l=0;n[l++]=r?Number(o):o;const s=i/f;for(;l<t;){const a=q(e),h=new Uint8Array(f);for(let p=0;p<f;p++)h[p]=e.view.getUint8(e.offset++);for(let p=0;p<f&&l<t;p++){const g=BigInt(h[p]);if(g){let w=0n,c=s;const _=(1n<<g)-1n;for(;c&&l<t;){let u=BigInt(e.view.getUint8(e.offset))>>w&_;for(w+=g;w>=8;)w-=8n,e.offset++,w&&(u|=BigInt(e.view.getUint8(e.offset))<<g-w&_);const y=a+u;o+=y,n[l++]=r?Number(o):o,c--}c&&(e.offset+=Math.ceil((c*Number(g)+Number(w))/8))}else for(let w=0;w<s&&l<t;w++)o+=a,n[l++]=r?Number(o):o}}}function Ge(e,t,n){const r=new Int32Array(t);B(e,t,r);for(let i=0;i<t;i++)n[i]=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,r[i]),e.offset+=r[i]}function je(e,t,n){const r=new Int32Array(t);B(e,t,r);const i=new Int32Array(t);B(e,t,i);for(let f=0;f<t;f++){const o=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,i[f]);r[f]?(n[f]=new Uint8Array(r[f]+i[f]),n[f].set(n[f-1].subarray(0,r[f])),n[f].set(o,r[f])):n[f]=o,e.offset+=i[f]}}function Qe(e,t,n,r,i){const f={view:new DataView(e.buffer,e.byteOffset,e.byteLength),offset:0},{codec:o,type:l}=r,s=t.data_page_header_v2;if(!s)throw new Error("parquet data page header v2 is undefined");const a=Xe(f,s,n);f.offset=s.repetition_levels_byte_length;const h=Ze(f,s,n),p=t.uncompressed_page_size-s.definition_levels_byte_length-s.repetition_levels_byte_length;let g=e.subarray(f.offset);s.is_compressed!==!1&&(g=C(g,p,o,i));const w=new DataView(g.buffer,g.byteOffset,g.byteLength),c={view:w,offset:0};let _;const u=s.num_values-s.num_nulls;if(s.encoding==="PLAIN"){const{type_length:y}=n[n.length-1].element;_=$(c,l,u,y)}else if(s.encoding==="RLE")_=new Array(u),N(c,1,0,_),_=_.map(y=>!!y);else if(s.encoding==="PLAIN_DICTIONARY"||s.encoding==="RLE_DICTIONARY"){const y=w.getUint8(c.offset++);_=new Array(u),N(c,y,p-1,_)}else if(s.encoding==="DELTA_BINARY_PACKED")_=l==="INT32"?new Int32Array(u):new BigInt64Array(u),B(c,u,_);else if(s.encoding==="DELTA_LENGTH_BYTE_ARRAY")_=new Array(u),Ge(c,u,_);else if(s.encoding==="DELTA_BYTE_ARRAY")_=new Array(u),je(c,u,_);else if(s.encoding==="BYTE_STREAM_SPLIT"){const{type_length:y}=n[n.length-1].element;_=se(f,u,l,y)}else throw new Error(`parquet unsupported encoding: ${s.encoding}`);return{definitionLevels:h,repetitionLevels:a,dataPage:_}}function Xe(e,t,n){const r=K(n);if(!r)return[];const i=new Array(t.num_values);return N(e,S(r),t.repetition_levels_byte_length,i),i}function Ze(e,t,n){const r=D(n);if(r){const i=new Array(t.num_values);return N(e,S(r),t.definition_levels_byte_length,i),i}}function He(e){const t=ee(e),n=G[t.field_1],r=t.field_2,i=t.field_3,f=t.field_4,o=t.field_5&&{num_values:t.field_5.field_1,encoding:b[t.field_5.field_2],definition_level_encoding:b[t.field_5.field_3],repetition_level_encoding:b[t.field_5.field_4],statistics:t.field_5.field_5&&{max:t.field_5.field_5.field_1,min:t.field_5.field_5.field_2,null_count:t.field_5.field_5.field_3,distinct_count:t.field_5.field_5.field_4,max_value:t.field_5.field_5.field_5,min_value:t.field_5.field_5.field_6}},l=t.field_6,s=t.field_7&&{num_values:t.field_7.field_1,encoding:b[t.field_7.field_2],is_sorted:t.field_7.field_3},a=t.field_8&&{num_values:t.field_8.field_1,num_nulls:t.field_8.field_2,num_rows:t.field_8.field_3,encoding:b[t.field_8.field_4],definition_levels_byte_length:t.field_8.field_5,repetition_levels_byte_length:t.field_8.field_6,is_compressed:t.field_8.field_7===void 0?!0:t.field_8.field_7,statistics:t.field_8.field_8};return{type:n,uncompressed_page_size:r,compressed_page_size:i,crc:f,data_page_header:o,index_page_header:l,dictionary_page_header:s,data_page_header_v2:a}}function F(e,t){for(let n=0;n<t.length;n+=1e4)e.push(...t.slice(n,n+1e4))}async function ue(e){return await fetch(e,{method:"HEAD"}).then(t=>{if(!t.ok)throw new Error(`fetch head failed ${t.status}`);const n=t.headers.get("Content-Length");if(!n)throw new Error("missing content length");return parseInt(n)})}async function Je(e,t){return t||(t=await ue(e)),{byteLength:t,async slice(n,r){const i=new Headers,f=r===void 0?"":r-1;i.set("Range",`bytes=${n}-${f}`);const o=await fetch(e,{headers:i});if(!o.ok||!o.body)throw new Error(`fetch failed ${o.status}`);return o.arrayBuffer()}}}function We(e,t,n,r,{compressors:i,utf8:f}){const{element:o}=r[r.length-1];let l;const s=[];for(;s.length<t;){const a=He(e),h=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,a.compressed_page_size);let p;if(a.type==="DATA_PAGE"){const g=a.data_page_header;if(!g)throw new Error("parquet data page header is undefined");const w=C(h,Number(a.uncompressed_page_size),n.codec,i),{definitionLevels:c,repetitionLevels:_,dataPage:u}=xe(w,g,r,n);if(p=Q(u,l,o,g.encoding,f),_.length||(c==null?void 0:c.length)){const y=D(r),d=r.map(({element:E})=>E.repetition_type);fe(s,c,_,p,d,y)}else{for(let y=2;y<r.length;y++)r[y].element.repetition_type!=="REQUIRED"&&(p=Array.from(p,d=>[d]));F(s,p)}}else if(a.type==="DATA_PAGE_V2"){const g=a.data_page_header_v2;if(!g)throw new Error("parquet data page header v2 is undefined");const{definitionLevels:w,repetitionLevels:c,dataPage:_}=Qe(h,a,r,n,i);if(p=Q(_,l,o,g.encoding,f),c.length||(w==null?void 0:w.length)){const u=D(r),y=r.map(({element:d})=>d.repetition_type);fe(s,w,c,p,y,u)}else F(s,p)}else if(a.type==="DICTIONARY_PAGE"){const g=a.dictionary_page_header;if(!g)throw new Error("parquet dictionary page header is undefined");const w=C(h,Number(a.uncompressed_page_size),n.codec,i);l=ke(w,g,n,o.type_length)}else throw new Error(`parquet unsupported page type: ${a.type}`);e.offset+=a.compressed_page_size}if(s.length<t)throw new Error(`parquet row data length ${s.length} does not match row group limit ${t}}`);return s.length>t&&(s.length=t),s}function de({dictionary_page_offset:e,data_page_offset:t,total_compressed_size:n}){let r=e;return(!r||t<r)&&(r=t),[r,r+n]}async function Ke(e){if(!e.file)throw new Error("parquet file is required");if(e.metadata||(e.metadata=await re(e.file)),!e.metadata)throw new Error("parquet metadata not found");const{metadata:t,onComplete:n,rowEnd:r}=e,i=e.rowStart||0,f=[];let o=0;for(const l of t.row_groups){const s=Number(l.num_rows);if(o+s>=i&&(r===void 0||o<r)){const a=r&&r-o,h=await et(e,l,o,a);if(n){const p=Math.max(i-o,0),g=r===void 0?void 0:r-o;F(f,h.slice(p,g))}}o+=s}n&&n(f)}async function et(e,t,n,r){const{file:i,metadata:f,columns:o}=e;if(!f)throw new Error("parquet metadata not found");(r===void 0||r>t.num_rows)&&(r=Number(t.num_rows));let[l,s]=[i.byteLength,0];if(t.columns.forEach(({meta_data:c})=>{if(!c)throw new Error("parquet column metadata is undefined");if(o&&!o.includes(c.path_in_schema[0]))return;const[_,u]=de(c).map(Number);l=Math.min(l,_),s=Math.max(s,u)}),l>=s&&(o==null?void 0:o.length))throw new Error(`parquet columns not found: ${o.join(", ")}`);let a;s-l<=1<<25&&(a=await i.slice(l,s));const h=[],{children:p}=W(f.schema,[])[0],g=new Map(p.map(c=>[c.element.name,ce(c)])),w=new Map;for(let c=0;c<t.columns.length;c++){const _=t.columns[c].meta_data;if(!_)throw new Error("parquet column metadata is undefined");const u=_.path_in_schema[0];if(o&&!o.includes(u))continue;const[y,d]=de(_).map(Number),E=d-y;if(E>1<<30){console.warn(`parquet skipping huge column "${_.path_in_schema}" ${E.toLocaleString()} bytes`);continue}let I,T=0;a?(I=Promise.resolve(a),T=y-l):I=Promise.resolve(i.slice(y,d)),h.push(I.then(A=>{var k,z;const x=W(f.schema,_.path_in_schema),_e={view:new DataView(A),offset:T};let v=We(_e,r,_,x,e);const he=_.path_in_schema.join(".");if(w.set(he,v),v=void 0,((k=g.get(u))==null?void 0:k.every(pe=>w.has(pe)))&&(R(w,x[1]),v=w.get(u),!v))throw new Error(`parquet column data not assembled: ${u}`);v&&((z=e.onChunk)==null||z.call(e,{columnName:u,columnData:v,rowStart:n,rowEnd:n+v.length}))}))}if(await Promise.all(h),e.onComplete){const c=new Array(r),_=p.map(d=>d.element.name).filter(d=>!o||o.includes(d)),u=o||_,y=u.map(d=>_.includes(d)?w.get(d):void 0);for(let d=0;d<r;d++)if(e.rowFormat==="object"){const E={};u.forEach((I,T)=>{var A;E[I]=(A=y[T])==null?void 0:A[d]}),c[d]=E}else c[d]=y.map(E=>E==null?void 0:E[d]);return c}return[]}function ce(e,t=[]){if(e.children.length)for(const n of e.children)ce(n,t);else t.push(e.path.join("."));return t}export{Je as asyncBufferFromUrl,ue as byteLengthFromUrl,Y as parquetMetadata,re as parquetMetadataAsync,Ke as parquetRead,ae as snappyUncompress};
